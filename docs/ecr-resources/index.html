<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>EC2 Container Registry Resources - Infrastructure Accelerator Tutorial</title>
    <meta name="generator" content="Hugo 0.19" />

    
    <meta name="description" content="Infrastructure Accelerator Tutorial">
    
    <link rel="canonical" href="https://casecommons.github.io/aws-docs/ecr-resources/">
    
    <meta name="author" content="Justin Menga">
    

    <meta property="og:url" content="https://casecommons.github.io/aws-docs/ecr-resources/">
    <meta property="og:title" content="Infrastructure Accelerator Tutorial">
    <meta property="og:image" content="https://casecommons.github.io/aws-docs/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="Infrastructure Accelerator Tutorial">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://casecommons.github.io/aws-docs/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://casecommons.github.io/aws-docs/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://casecommons.github.io/aws-docs/fonts/icon.eot');
        src: url('https://casecommons.github.io/aws-docs/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://casecommons.github.io/aws-docs/fonts/icon.woff')
               format('woff'),
             url('https://casecommons.github.io/aws-docs/fonts/icon.ttf')
               format('truetype'),
             url('https://casecommons.github.io/aws-docs/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://casecommons.github.io/aws-docs/stylesheets/application.css">
    <link rel="stylesheet" href="https://casecommons.github.io/aws-docs/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://casecommons.github.io/aws-docs/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://casecommons.github.io/aws-docs/stylesheets/highlight/highlight.css">
    <link rel="stylesheet" href="https://casecommons.github.io/aws-docs/stylesheets/overrides.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu&#43;Mono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://casecommons.github.io/aws-docs/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-red palette-accent-teal">




<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        EC2 Container Registry Resources
      </div>
    </div>

    
    <div class="button button-twitter" role="button" aria-label="Twitter">
       <a href="https://twitter.com/jmenga" title="@jmenga on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
    </div>
    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/mixja" title="@mixja on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://casecommons.github.io/aws-docs/" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="https://casecommons.github.io/aws-docs/images/logo.png">
        </div>
      
      <div class="name">
        <strong>Infrastructure Accelerator Tutorial <span class="version">v0.2</span></strong>
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Introduction" href="https://casecommons.github.io/aws-docs/">
	
	Introduction
</a>



  
</li>



<li>
  
    



<a  title="Local Setup" href="https://casecommons.github.io/aws-docs/local-setup/">
	
	Local Setup
</a>



  
</li>



<li>
  
    



<a  title="Security Resources" href="https://casecommons.github.io/aws-docs/security-resources/">
	
	Security Resources
</a>



  
</li>



<li>
  
    



<a  title="CloudFormation Resources" href="https://casecommons.github.io/aws-docs/cloudformation-resources/">
	
	CloudFormation Resources
</a>



  
</li>



<li>
  
    



<a  title="Network Resources" href="https://casecommons.github.io/aws-docs/network-resources/">
	
	Network Resources
</a>



  
</li>



<li>
  
    



<a class="current" title="EC2 Container Registry Resources" href="https://casecommons.github.io/aws-docs/ecr-resources/">
	
	EC2 Container Registry Resources
</a>


<ul id="scrollspy">
</ul>


  
</li>



<li>
  
    



<a  title="Web Proxy Stack" href="https://casecommons.github.io/aws-docs/web-proxy/">
	
	Web Proxy Stack
</a>



  
</li>



<li>
  
    



<a  title="Intake API Stack" href="https://casecommons.github.io/aws-docs/intake-api/">
	
	Intake API Stack
</a>



  
</li>



<li>
  
    



<a  title="Intake Accelerator Stack" href="https://casecommons.github.io/aws-docs/intake-accelerator/">
	
	Intake Accelerator Stack
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          
          <li>
            <a href="https://twitter.com/jmenga" target="_blank" title="@jmenga on Twitter">
              @jmenga on Twitter
            </a>
          </li>
          

          
          <li>
            <a href="https://github.com/mixja" target="_blank" title="@mixja on GitHub">
              @mixja on GitHub
            </a>
          </li>
          

          
          <li>
            <a href="mailto:justin.menga@gmail.com" title="Email of justin.menga@gmail.com">
              Contact via email
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>EC2 Container Registry Resources </h1>

			

<h2 id="introduction">Introduction</h2>

<p>The <a href="https://github.com/casecommons/aws-cloudformation">aws-cloudformation</a> role includes a <a href="https://github.com/casecommons/aws-cloudformation/blob/master/templates/ecr.yml.j2">EC2 container registry template</a> that is designed to define the following AWS resources:</p>

<ul>
<li>EC2 Container Registry (ECR) repositories</li>
</ul>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Before commencing the tasks below, ensure you have successfully completed all tasks in the following sections:</p>

<ul>
<li><a href="https://casecommons.github.io/aws-docs/security-resources/">Security Resources</a></li>
<li><a href="https://casecommons.github.io/aws-docs/cloudformation-resources/">CloudFormation Resources</a></li>
</ul>
</p>
</div>

<h2 id="creating-the-playbook">Creating the Playbook</h2>

<p>We will get started by establishing a network resources playbook that defines network resources for <strong>Demo Resources</strong> account.</p>

<p>1. Clone the <a href="https://github.com/casecommons/aws-starter">AWS Starter</a> to a local folder called <code>demo-ecr-resources</code> and re-initialise the Git repository.</p>

<pre><code class="language-bash">$ git clone git@github.com:casecommons/aws-starter.git demo-ecr-resources
  Cloning into 'demo-ecr-resources'...
  remote: Counting objects: 22, done.
  remote: Compressing objects: 100% (14/14), done.
  remote: Total 22 (delta 4), reused 22 (delta 4), pack-reused 0
  Receiving objects: 100% (22/22), done.
  Resolving deltas: 100% (4/4), done
$ cd demo-ecr-resources
$ rm -rf .git
$ git init
Initialized empty Git repository in /Users/jmenga/Source/casecommons/demo-ecr-resources/.git/
</code></pre>

<p>2.  Update the <code>roles/requirements.yml</code> file to the desired versions for each role:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="c1"># You can specify git tag, commit or branch for the version property</span>
<span class="o">-</span> <span class="n">src</span><span class="p">:</span> <span class="n">git</span><span class="nd">@github.com</span><span class="p">:</span><span class="n">casecommons</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">cloudformation</span><span class="o">.</span><span class="n">git</span>
  <span class="n">scm</span><span class="p">:</span> <span class="n">git</span>
<span class="hll">  <span class="n">version</span><span class="p">:</span> <span class="mf">0.7</span><span class="o">.</span><span class="mi">0</span>
</span>  <span class="n">name</span><span class="p">:</span> <span class="n">aws</span><span class="o">-</span><span class="n">cloudformation</span>
<span class="o">-</span> <span class="n">src</span><span class="p">:</span> <span class="n">git</span><span class="nd">@github.com</span><span class="p">:</span><span class="n">casecommons</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">sts</span><span class="o">.</span><span class="n">git</span>
  <span class="n">scm</span><span class="p">:</span> <span class="n">git</span>
<span class="hll">  <span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="mi">2</span>
</span>  <span class="n">name</span><span class="p">:</span> <span class="n">aws</span><span class="o">-</span><span class="n">sts</span>
</code></pre></div>


<p>3.  Install the roles using the <code>ansible-galaxy</code> command as demonstrated below:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="err">$</span> <span class="n">ansible</span><span class="o">-</span><span class="n">galaxy</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">roles</span><span class="o">/</span><span class="n">requirements</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">force</span>
<span class="o">-</span> <span class="n">extracting</span> <span class="n">aws</span><span class="o">-</span><span class="n">cloudformation</span> <span class="n">to</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">jmenga</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">casecommons</span><span class="o">/</span><span class="n">demo</span><span class="o">-</span><span class="n">ecr</span><span class="o">-</span><span class="n">resources</span><span class="o">/</span><span class="n">roles</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">cloudformation</span>
<span class="o">-</span> <span class="n">aws</span><span class="o">-</span><span class="n">cloudformation</span> <span class="n">was</span> <span class="n">installed</span> <span class="n">successfully</span>
<span class="o">-</span> <span class="n">extracting</span> <span class="n">aws</span><span class="o">-</span><span class="n">sts</span> <span class="n">to</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">jmenga</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">casecommons</span><span class="o">/</span><span class="n">demo</span><span class="o">-</span><span class="n">ecr</span><span class="o">-</span><span class="n">resources</span><span class="o">/</span><span class="n">roles</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">sts</span>
<span class="o">-</span> <span class="n">aws</span><span class="o">-</span><span class="n">sts</span> <span class="n">was</span> <span class="n">installed</span> <span class="n">successfully</span>
</code></pre></div>


<p>4.  Modify the <code>group_vars/all/vars.yml</code> file, which contains global settings for the playbook:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="c1"># Stack Settings</span>
<span class="n">cf_stack_name</span><span class="p">:</span> <span class="n">ecr</span><span class="o">-</span><span class="n">resources</span>
<span class="hll"><span class="n">cf_stack_template</span><span class="p">:</span> <span class="s2">&quot;templates/ecr.yml.j2&quot;</span>
</span><span class="n">cf_stack_tags</span><span class="p">:</span>
  <span class="n">org</span><span class="p">:</span><span class="n">business</span><span class="p">:</span><span class="n">owner</span><span class="p">:</span> <span class="n">Casecommons</span>
  <span class="n">org</span><span class="p">:</span><span class="n">business</span><span class="p">:</span><span class="n">product</span><span class="p">:</span> <span class="n">ECR</span> <span class="n">Resources</span>
  <span class="n">org</span><span class="p">:</span><span class="n">business</span><span class="p">:</span><span class="n">severity</span><span class="p">:</span> <span class="n">High</span>
  <span class="n">org</span><span class="p">:</span><span class="n">tech</span><span class="p">:</span><span class="n">environment</span><span class="p">:</span> <span class="s2">&quot;{{ env }}&quot;</span>
  <span class="n">org</span><span class="p">:</span><span class="n">tech</span><span class="p">:</span><span class="n">contact</span><span class="p">:</span> <span class="n">pema</span><span class="nd">@casecommons.org</span>
  
<span class="c1"># CloudFormation settings</span>
<span class="c1"># This sets a policy that disables updates to existing resources</span>
<span class="c1"># This requires you to explicitly set the cf_disable_stack_policy flag to true when running the playbook</span>
<span class="n">cf_stack_policy</span><span class="p">:</span>
  <span class="n">Statement</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">Effect</span><span class="p">:</span> <span class="s2">&quot;Deny&quot;</span>
    <span class="n">Action</span><span class="p">:</span> <span class="s2">&quot;Update:*&quot;</span>
    <span class="n">Principal</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
    <span class="n">Resource</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
</code></pre></div>


<p>Notice that we reference the <a href="https://github.com/casecommons/aws-cloudformation/blob/master/templates/ecr.yml.j2">templates/ecr.yml.y2 template</a> that is embedded within the <a href="https://github.com/casecommons/aws-cloudformation">aws-cloudformation role</a>.</p>

<p>5. Remove the local <code>templates</code> folder, since we are using a template that is embedded within the <code>aws-cloudformation</code> role:</p>

<pre><code class="language-bash">$ rm -rf templates
</code></pre>

<h2 id="defining-a-new-environment">Defining a New Environment</h2>

<p>We will now add a new environment called <strong>demo-resources</strong> to the playbook, which will be used to create CloudFormation resources in the <strong>demo-resources</strong> account.</p>

<p>1. Modify the <code>inventory</code> file so that it defines a single environment called <strong>demo-resources</strong>, ensuring you specify <code>ansible_connection=local</code>:</p>

<pre><code class="language-toml">[demo-resources]
demo-resources ansible_connection=local
</code></pre>

<p>2. Remove the <code>group_vars/non-prod</code> environment folder that is included in the starter template:</p>

<pre><code class="language-bash">$ rm -rf group_vars/non-prod
</code></pre>

<p>3. Create a file called <code>group_vars/demo-resources/vars.yml</code>, which will hold all environment specific configuration for the <strong>demo-resources</strong> environment:</p>

<pre><code class="language-bash">$ mkdir -p group_vars/demo-resources
$ touch group_vars/demo-resources/vars.yml
</code></pre>

<p>4. Add the following settings to <code>group_vars/demo-resources/vars.yml</code>:</p>

<pre><code class="language-python"># STS role to assume
sts_role_arn: arn:aws:iam::160775127577:role/admin

# Repositories
config_ecr_repos:
  casecommons/intake: {}
  casecommons/intake-api: {}
  casecommons/intake-base: {}
  casecommons/elasticsearch: {}
  casecommons/nginx: {}
  casecommons/squid: {}
</code></pre>

<p>Here we target the <strong>demo-resources</strong> account by specifying the <strong>demo-resources</strong> IAM <strong>admin</strong> role in the <code>sts_role_arn</code> variable, whilst the <code>config_ecr_repos</code> dicitionary defines the ECR repositories resources that will be created:</p>

<ul>
<li><code>casecommons/intake</code> - repository for the Casecommons Intake Accelerator application image</li>
<li><code>casecommons/intake-api</code> - repository for the Casecommons Intake API application image</li>
<li><code>casecommons/intake-base</code> - repository for the Casecommons base image used for the Intake Accelerator and Intake API application images</li>
<li><code>casecommons/elasticsearch</code> - repository for the Casecommons ElasticSearch image</li>
<li><code>casecommons/nginx</code> - repository for the Casecommons Nginx image</li>
<li><code>casecommons/squid</code> - repository for the Casecommons Squid proxy image</li>
</ul>

<h2 id="running-the-playbook">Running the Playbook</h2>

<p>Now that we&rsquo;ve defined environment settings for the <strong>demo-resources</strong> environment, let&rsquo;s run the playbook to create ECR repository resources for the environment.</p>

<p>1. Ensure your local AWS environment is configured to target the <strong>demo-resources</strong> account:</p>

<pre><code class="language-bash">$ export AWS_PROFILE=demo-resources-admin
</code></pre>

<p>2. Run the Ansible playbook targeting the <code>demo-resources</code> environment as demonstrated below:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ ansible-playbook site.yml -e <span class="nv">env</span><span class="o">=</span>demo-resources

PLAY <span class="o">[</span>Assume Role<span class="o">]</span> *************************************************************

TASK <span class="o">[</span>aws-sts : set_fact<span class="o">]</span> ******************************************************
ok: <span class="o">[</span>demo-resources<span class="o">]</span>

TASK <span class="o">[</span>aws-sts : checking <span class="k">if</span> sts functions are sts_disabled<span class="o">]</span> ********************
skipping: <span class="o">[</span>demo-resources<span class="o">]</span>

TASK <span class="o">[</span>aws-sts : setting empty sts_session_output result<span class="o">]</span> ***********************
skipping: <span class="o">[</span>demo-resources<span class="o">]</span>

TASK <span class="o">[</span>aws-sts : setting sts_creds <span class="k">if</span> legacy AWS credentials are present <span class="o">(</span>e.g. <span class="k">for</span> Ansible Tower<span class="o">)]</span> ***
skipping: <span class="o">[</span>demo-resources<span class="o">]</span>

TASK <span class="o">[</span>aws-sts : assume sts role<span class="o">]</span> ***********************************************
Enter MFA code: ******
ok: <span class="o">[</span>demo-resources<span class="o">]</span>
...
...
TASK <span class="o">[</span>aws-cloudformation : <span class="nb">set</span> <span class="nb">local</span> path fact <span class="k">if</span> s3 upload disabled<span class="o">]</span> **********
ok: <span class="o">[</span>demo-resources<span class="o">]</span>

TASK <span class="o">[</span>aws-cloudformation : configure application stack<span class="o">]</span> ************************
...
...
PLAY RECAP *********************************************************************
demo-resources             : <span class="nv">ok</span><span class="o">=</span><span class="m">20</span>   <span class="nv">changed</span><span class="o">=</span><span class="m">1</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>
</code></pre></div>


<p>3.  The playbook will take a few minutes to create the CloudFormation stack and associated resources.  Whilst the CloudFormation stack is being created, you can review the CloudFormation stack that was generated in the <code>build/&lt;timestamp&gt;</code> folder:</p>

<pre><code class="language-bash">$ tree build
build
└── 20170226213833
    ├── ecr-resources-config.json
    ├── ecr-resources-policy.json
    ├── ecr-resources-stack.json
    └── ecr-resources-stack.yml
</code></pre>

<p>The following shows the <code>ecr-resources-stack.yml</code> file that was generated and uploaded to CloudFormation:</p>

<pre><code class="language-python">AWSTemplateFormatVersion: &quot;2010-09-09&quot;

Description: ECR Repositories

Resources:
  CasecommonsSquid:
    Type: &quot;AWS::ECR::Repository&quot;
    Properties:
      RepositoryName: &quot;casecommons/squid&quot;
  CasecommonsIntakeBase:
    Type: &quot;AWS::ECR::Repository&quot;
    Properties:
      RepositoryName: &quot;casecommons/intake-base&quot;
  CasecommonsIntakeApi:
    Type: &quot;AWS::ECR::Repository&quot;
    Properties:
      RepositoryName: &quot;casecommons/intake-api&quot;
  CasecommonsNginx:
    Type: &quot;AWS::ECR::Repository&quot;
    Properties:
      RepositoryName: &quot;casecommons/nginx&quot;
  CasecommonsElasticsearch:
    Type: &quot;AWS::ECR::Repository&quot;
    Properties:
      RepositoryName: &quot;casecommons/elasticsearch&quot;
  CasecommonsIntake:
    Type: &quot;AWS::ECR::Repository&quot;
    Properties:
      RepositoryName: &quot;casecommons/intake&quot;
</code></pre>

<p>4. Once the playbook execution completes successfully, login to the <strong>demo-resources</strong> account.  You should see a new CloudFormation stack called <code>ecr-resources</code>:</p>

<p><img src="https://casecommons.github.io/aws-docs/images/ecr-resources.png" alt="ECR Resources Stack" /></p>

<p>Notice that each of the specified ECR repositories have been created.</p>

<p>5. If you open the ECS dashboard and select <strong>Repositories</strong>, you can see each of the created ECR Repositories:</p>

<p><img src="https://casecommons.github.io/aws-docs/images/ecr-repositories.png" alt="ECR Repositories" /></p>

<p>6. Select the <strong>casecommons/squid</strong> repository, which will display details about this repository:</p>

<p><img src="https://casecommons.github.io/aws-docs/images/ecr-squid-repository.png" alt="ECR Repositories" /></p>

<p>Notice the <strong>Repository URI</strong> setting for the <strong>squid</strong> repository - this is the fully qualified name you should use when referencing images in this repository and is comprised of three parts:</p>

<ul>
<li><code>160775127577.dkr.ecr.us-west-2.amazonaws.com</code> - the Docker registry name</li>
<li><code>casecommons</code> - the Docker organization name</li>
<li><code>squid</code> - the Docker repository name</li>
</ul>

<p>We need to specify the <strong>Repository URI</strong> whenever we tag and publish images for this repository.</p>

<h2 id="publishing-docker-images">Publishing Docker Images</h2>

<p>In this section we will demonstrate how to publish a Docker image to one of our newly created ECR repositories.  We will create an image for the <strong>casecommons/squid</strong> repository using the Docker squid image that is defined at <a href="https://github.com/casecommons/docker-squid">https://github.com/casecommons/docker-squid</a>.</p>

<p>1. Clone the Casecommons squid repository to your local environment:</p>

<pre><code class="language-bash">$ git clone git@github.com:Casecommons/docker-squid.git
Cloning into 'docker-squid'...
remote: Counting objects: 62, done.
remote: Total 62 (delta 0), reused 0 (delta 0), pack-reused 62
Receiving objects: 100% (62/62), 12.48 KiB | 0 bytes/s, done.
Resolving deltas: 100% (16/16), done.
$ cd docker-squid
$ tree -L 1
.
├── Makefile
├── Makefile.settings
├── README.md
├── docker
└── src
</code></pre>

<p>2. Open the <code>Makefile</code> at the root of the <strong>docker-squid</strong> repository and modify the highlighted settings:</p>

<div class="highlight"><pre><code class="language-make" data-lang="make"><span></span><span class="c"># Project variables</span>
<span class="k">export </span><span class="nv">PROJECT_NAME</span> <span class="o">?=</span> squid
<span class="hll"><span class="nv">ORG_NAME</span> <span class="o">?=</span> casecommons
</span><span class="hll"><span class="nv">REPO_NAME</span> <span class="o">?=</span> squid
</span><span class="hll"><span class="nv">DOCKER_REGISTRY</span> <span class="o">?=</span> <span class="m">160775127577</span>.dkr.ecr.us-west-2.amazonaws.com
</span><span class="hll"><span class="nv">AWS_ACCOUNT_ID</span> <span class="o">?=</span> <span class="m">160775127577</span>
</span><span class="nv">DOCKER_LOGIN_EXPRESSION</span> <span class="o">?=</span> <span class="nv">$$</span><span class="o">(</span>aws ecr get-login --registry-ids <span class="k">$(</span>AWS_ACCOUNT_ID<span class="k">)</span><span class="o">)</span>
<span class="err">...</span>
<span class="err">...</span>
</code></pre></div>


<p>Here we ensure the <code>Makefile</code> settings are configured with the correct Docker registry name (<code>DOCKER_REGISTRY</code>), organization name (<code>ORG_NAME</code>), repository name (<code>REPO_NAME</code>) and AWS account ID (<code>AWS_ACCOUNT_ID</code>).</p>

<p>3. Run the <code>make login</code> command to login to the ECR repository for the <strong>demo-resources</strong> account:</p>

<pre><code class="language-bash">$ export AWS_PROFILE=demo-resources-admin
$ make login
=&gt; Logging in to Docker registry ...
Enter MFA code: *****
Login Succeeded
=&gt; Logged in to Docker registry
</code></pre>

<p>4. Run the <code>make release</code> command, which will build the squid image:</p>

<pre><code class="language-bash">$ make release
=&gt; Building images...
Building squid
Step 1/11 : FROM alpine
...
...
=&gt; Build complete
=&gt; Starting squid service...
Creating network &quot;squid_default&quot; with the default driver
Creating squid_squid_1
=&gt; Release environment created
=&gt; Squid is running at http://172.16.154.128:32776
</code></pre>

<p>4. Run the <code>make tag latest</code> command, which will tag the image with the <code>latest</code> tag:</p>

<pre><code class="language-bash">$ make tag latest
=&gt; Tagging release image with tags latest...
=&gt; Tagging complete
</code></pre>

<p>5. Run the <code>make publish</code> command, which will publish the image to your ECR repository:</p>

<pre><code class="language-bash">$ make publish
=&gt; Publishing release image to 160775127577.dkr.ecr.us-west-2.amazonaws.com/casecommons/squid...
The push refers to a repository [160775127577.dkr.ecr.us-west-2.amazonaws.com/casecommons/squid]
a99ab02493c4: Pushed
de9eaa36d055: Pushed
ac2f445f0e4a: Pushed
6566ea35d012: Pushed
60ab55d3379d: Pushed
latest: digest: sha256:086598386c752d053436cb46aedc52f6c03026e53981936c4d8b867ce042ac66 size: 1362
=&gt; Publish complete
</code></pre>

<p>6. Run the <code>make clean</code> command to clean up the local Docker environment.</p>

<pre><code class="language-bash">$ make clean
=&gt; Destroying release environment...
Stopping squid_squid_1 ... done
Removing squid_squid_1 ... done
Removing network squid_default
=&gt; Removing dangling images...
</code></pre>

<p>7. In the AWS console, you should now be able to see your newly published image:</p>

<p><img src="https://casecommons.github.io/aws-docs/images/ecr-squid-image.png" alt="Squid Image" /></p>

<h2 id="wrap-up">Wrap Up</h2>

<p>We created ECR repositories in our <strong>demo-resources</strong> account, which provides a private Docker registry and repositories for publishing Docker images, and learned how to publish Docker images to our ECR repositories.</p>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At this point you should commit your changes to the ECR resources playbook before continuing.</p>
</div>


			<aside class="copyright" role="note">
				
				&copy; 2017 Released under the AGPL license &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="https://casecommons.github.io/aws-docs/network-resources/" title="Network Resources">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Network Resources
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="https://casecommons.github.io/aws-docs/web-proxy/" title="Web Proxy Stack">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Web Proxy Stack
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = '';
      var repo_id  = '';
    
    </script>

    <script src="https://casecommons.github.io/aws-docs/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

