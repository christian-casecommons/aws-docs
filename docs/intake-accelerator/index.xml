<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Intake-accelerators on AWS CloudFormation Tutorial</title>
    <link>https://casecommons.github.io/aws-docs/intake-accelerator/index.xml</link>
    <description>Recent content in Intake-accelerators on AWS CloudFormation Tutorial</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>Released under the MIT license</copyright>
    <lastBuildDate>Mon, 27 Feb 2017 02:59:17 +1300</lastBuildDate>
    <atom:link href="https://casecommons.github.io/aws-docs/intake-accelerator/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Intake Accelerator Stack</title>
      <link>https://casecommons.github.io/aws-docs/intake-accelerator/</link>
      <pubDate>Mon, 27 Feb 2017 02:59:17 +1300</pubDate>
      
      <guid>https://casecommons.github.io/aws-docs/intake-accelerator/</guid>
      <description>

&lt;h2 id=&#34;introduction&#34;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;The &lt;a href=&#34;https://github.com/casecommons/aws-cloudformation&#34;&gt;aws-cloudformation&lt;/a&gt; role includes a &lt;a href=&#34;https://github.com/casecommons/aws-cloudformation/blob/master/templates/proxy.yml.j2&#34;&gt;web proxy template&lt;/a&gt; that is designed to create the following AWS resources:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Web Proxy using the popular &lt;a href=&#34;http://www.squid-cache.org&#34;&gt;squid&lt;/a&gt; open source web proxy application&lt;/li&gt;
&lt;li&gt;EC2 autoscaling group for running ECS container instances&lt;/li&gt;
&lt;li&gt;ECS cluster including ECS container instances that can run the squid containers&lt;/li&gt;
&lt;li&gt;ECS task definition for defining the runtime configuration of the squid container&lt;/li&gt;
&lt;li&gt;ECS service for running the squid containers as a long running service, integrated with a front-end Elastic Load Balancer (ELB)&lt;/li&gt;
&lt;li&gt;Elastic Load Balancer (ELB) for load balancing incoming HTTP proxy requests from hosts using the squid proxy&lt;/li&gt;
&lt;li&gt;Route 53 host record defining a friendly URL for the squid proxy&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&#34;admonition note&#34;&gt;
&lt;p class=&#34;admonition-title&#34;&gt;Note&lt;/p&gt;
&lt;p&gt;Before commencing the tasks below, ensure you have successfully completed all tasks in the following sections:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://casecommons.github.io/aws-docs/security-resources/&#34;&gt;Security Resources&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://casecommons.github.io/aws-docs/cloudformation-resources/&#34;&gt;CloudFormation Resources&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://casecommons.github.io/aws-docs/ecr-resources/&#34;&gt;EC2 Container Registry Resources&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/p&gt;
&lt;/div&gt;

&lt;h2 id=&#34;creating-an-ecs-ami&#34;&gt;Creating an ECS AMI&lt;/h2&gt;

&lt;p&gt;We are creating our first CloudFormation stack that includes ECS resources, and we need to create a custom ECS Amazon Machine Image (AMI) that is designed to work with the proxy template.&lt;/p&gt;

&lt;p&gt;The Packer ECS repository is located at &lt;a href=&#34;https://github.com/Casecommons/packer-ecs&#34;&gt;https://github.com/Casecommons/packer-ecs&lt;/a&gt; and includes a workflow that can be configured to publish the Packer ECS image to the AWS account of your choice.&lt;/p&gt;

&lt;p&gt;1. Clone the Packer ECS repository to your local environment:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ git clone git@github.com:casecommons/packer-ecs
Cloning into &#39;packer-ecs&#39;...
remote: Counting objects: 143, done.
remote: Total 143 (delta 0), reused 0 (delta 0), pack-reused 143
Receiving objects: 100% (143/143), 21.66 KiB | 0 bytes/s, done.
Resolving deltas: 100% (55/55), done.
$ cd packer-ecs
$ tree -L 1
.
├── Makefile
├── Makefile.settings
├── README.md
├── docker
└── src
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2. Open the &lt;code&gt;Makefile&lt;/code&gt; at the root of the &lt;strong&gt;packer-ecs&lt;/strong&gt; repository and modify the highlighted settings:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-make&#34; data-lang=&#34;make&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# Project variables&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;export &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;PROJECT_NAME&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;?=&lt;/span&gt; packer

&lt;span class=&#34;c&#34;&gt;# AWS security settings&lt;/span&gt;
&lt;span class=&#34;hll&#34;&gt;&lt;span class=&#34;nv&#34;&gt;AWS_ROLE&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;?=&lt;/span&gt; arn:aws:iam::160775127577:role/admin
&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;AWS_SG_NAME&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;?=&lt;/span&gt; packer-&lt;span class=&#34;k&#34;&gt;$(&lt;/span&gt;MY_IP_ADDRESS&lt;span class=&#34;k&#34;&gt;)&lt;/span&gt;-&lt;span class=&#34;k&#34;&gt;$(&lt;/span&gt;TIMESTAMP&lt;span class=&#34;k&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;nv&#34;&gt;AWS_SG_DESCRIPTION&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;?=&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;Temporary security group for Packer&amp;quot;&lt;/span&gt;
&lt;span class=&#34;err&#34;&gt;...&lt;/span&gt;
&lt;span class=&#34;err&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Here we ensure the &lt;code&gt;Makefile&lt;/code&gt; settings are configured with the IAM &lt;strong&gt;admin&lt;/strong&gt; role for the &lt;strong&gt;demo-resources&lt;/strong&gt; account (&lt;code&gt;AWS_ROLE&lt;/code&gt;), as the ECS AMI build process will publish the AMI to the account associated with this role.&lt;/p&gt;

&lt;p&gt;3. Run the &lt;code&gt;make release&lt;/code&gt; command to build the Packer image:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span&gt;&lt;/span&gt;$ &lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;AWS_PROFILE&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;demo-resources-admin
$ make release
Enter MFA code: ******
&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;gt; Starting packer build...
&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;gt; Creating packer security group...
&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;gt; Creating packer image...
Building packer
Step &lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;/10 : FROM alpine
...
...
Step &lt;span class=&#34;m&#34;&gt;10&lt;/span&gt;/10 : CMD packer build packer.json
 ---&amp;gt; Running in 7de75cd744a5
 ---&amp;gt; 6cefa9dcc744
Removing intermediate container 7de75cd744a5
Successfully built &lt;span class=&#34;nv&#34;&gt;6cefa9dcc744&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;gt; Running packer build...
Creating network &lt;span class=&#34;s2&#34;&gt;&amp;quot;packer_default&amp;quot;&lt;/span&gt; with the default driver
Creating packer_packer_1
Attaching to packer_packer_1
packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;2017&lt;/span&gt;-02-26T09:52:22Z 52bf8983fb4e confd&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: INFO Backend &lt;span class=&#34;nb&#34;&gt;set&lt;/span&gt; to env
packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;2017&lt;/span&gt;-02-26T09:52:22Z 52bf8983fb4e confd&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: INFO Starting confd
packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;2017&lt;/span&gt;-02-26T09:52:22Z 52bf8983fb4e confd&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: INFO Backend nodes &lt;span class=&#34;nb&#34;&gt;set&lt;/span&gt; to
packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;2017&lt;/span&gt;-02-26T09:52:22Z 52bf8983fb4e confd&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: INFO Target config /packer/packer.json out of sync
packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;2017&lt;/span&gt;-02-26T09:52:22Z 52bf8983fb4e confd&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: INFO Target config /packer/packer.json has been updated
packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; amazon-ebs output will be in this color.
packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;
packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&amp;gt; amazon-ebs: Prevalidating AMI Name...
packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;     amazon-ebs: Found Image ID: ami-8e7bc4ee
packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&amp;gt; amazon-ebs: Creating temporary keypair: packer_58b2a556-84ff-72db-9874-eb14567c2bc5
packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&amp;gt; amazon-ebs: Launching a &lt;span class=&#34;nb&#34;&gt;source&lt;/span&gt; AWS instance...
packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;     amazon-ebs: Instance ID: i-01c267d7e0219e85f
...
...
packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&amp;gt; Builds finished. The artifacts of successful builds are:
packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; --&amp;gt; amazon-ebs: AMIs were created:
packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;
&lt;span class=&#34;hll&#34;&gt;packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; us-west-2: ami-4662e126
&lt;/span&gt;packer_1  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; --&amp;gt; amazon-ebs:
packer_packer_1 exited with code &lt;span class=&#34;nv&#34;&gt;0&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;gt; Deleting packer security group...
&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;gt; Deleted packer security group...
&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;gt; Build &lt;span class=&#34;nb&#34;&gt;complete&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The ECS AMI build will take a few minutes to complete.  Once the build has finished, take a note of the AMI ID, which in the output above is &lt;strong&gt;ami-4662e126&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;4. Run the &lt;code&gt;make clean&lt;/code&gt; command to clean up the local Docker environment.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ make clean
=&amp;gt; Destroying release environment...
=&amp;gt; Removing dangling images...
=&amp;gt; Clean complete
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;5. In the AWS console, navigate to &lt;strong&gt;EC2 &amp;gt; Images &amp;gt; AMIs&lt;/strong&gt;:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://casecommons.github.io/aws-docs/images/ecs-ami.png&#34; alt=&#34;Squid Image&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Notice that the AMI built in Step 3 is published and available in the &lt;strong&gt;demo-resources&lt;/strong&gt; account.&lt;/p&gt;

&lt;h2 id=&#34;creating-an-ec2-key-pair&#34;&gt;Creating an EC2 Key Pair&lt;/h2&gt;

&lt;p&gt;The web proxy template requires an EC2 keypair name to be provided as an input, which will be granted SSH access to the ECS container instances created as part of the web proxy stack.&lt;/p&gt;

&lt;p&gt;1. In the AWS console, navigate to &lt;strong&gt;EC2 &amp;gt; Network &amp;amp; Security &amp;gt; Key Pairs&lt;/strong&gt; and click on the &lt;strong&gt;Create Key Pair&lt;/strong&gt; button:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://casecommons.github.io/aws-docs/images/ec2-key-pairs.png&#34; alt=&#34;EC2 Key Pairs&#34; /&gt;&lt;/p&gt;

&lt;p&gt;2. Name the key &lt;strong&gt;admin&lt;/strong&gt; and click on the &lt;strong&gt;Create&lt;/strong&gt; button.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://casecommons.github.io/aws-docs/images/ec2-create-key-pair.png&#34; alt=&#34;Create EC2 Key Pair&#34; /&gt;&lt;/p&gt;

&lt;p&gt;3. A new key pair is created and a SSH private key file is downloaded to your computer:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://casecommons.github.io/aws-docs/images/ec2-admin-key-pair.png&#34; alt=&#34;Create EC2 Key Pair&#34; /&gt;&lt;/p&gt;

&lt;p&gt;4. Move the SSH private key file to your &lt;code&gt;~/.ssh&lt;/code&gt; folder and ensure the required permissions are set:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mv ~/Downloads/admin.pem.txt ~/.ssh/demo-resources-admin.pem
$ chmod 600 ~/.ssh/demo-resources-admin.pem
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;creating-the-playbook&#34;&gt;Creating the Playbook&lt;/h2&gt;

&lt;p&gt;We can now get started establishing a proxy playbook that defines a proxy stack for the &lt;strong&gt;Demo Resources&lt;/strong&gt; account.&lt;/p&gt;

&lt;p&gt;1. Clone the &lt;a href=&#34;https://github.com/casecommons/aws-starter&#34;&gt;AWS Starter&lt;/a&gt; to a local folder called &lt;code&gt;demo-proxy&lt;/code&gt; and the re-initialise the Git repository.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ git clone git@github.com:casecommons/aws-starter.git demo-proxy
  Cloning into &#39;demo-proxy&#39;...
  remote: Counting objects: 22, done.
  remote: Compressing objects: 100% (14/14), done.
  remote: Total 22 (delta 4), reused 22 (delta 4), pack-reused 0
  Receiving objects: 100% (22/22), done.
  Resolving deltas: 100% (4/4), done
$ cd demo-proxy
$ rm -rf .git
$ git init
Initialized empty Git repository in /Users/jmenga/Source/casecommons/demo-proxy/.git/
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2.  Update the &lt;code&gt;roles/requirements.yml&lt;/code&gt; file to the desired versions for each role:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# You can specify git tag, commit or branch for the version property&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;src&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;git&lt;/span&gt;&lt;span class=&#34;nd&#34;&gt;@github.com&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;casecommons&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;aws&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cloudformation&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;git&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;scm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;git&lt;/span&gt;
&lt;span class=&#34;hll&#34;&gt;  &lt;span class=&#34;n&#34;&gt;version&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;mf&#34;&gt;0.7&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;
&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;aws&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cloudformation&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;src&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;git&lt;/span&gt;&lt;span class=&#34;nd&#34;&gt;@github.com&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;casecommons&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;aws&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sts&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;git&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;scm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;git&lt;/span&gt;
&lt;span class=&#34;hll&#34;&gt;  &lt;span class=&#34;n&#34;&gt;version&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;mf&#34;&gt;0.1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;
&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;aws&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sts&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;4.  Install the roles using the &lt;code&gt;ansible-galaxy&lt;/code&gt; command as demonstrated below:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ansible&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;galaxy&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;install&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;roles&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;requirements&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;yml&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;--&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;force&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;extracting&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;aws&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cloudformation&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;to&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Users&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;jmenga&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Source&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;casecommons&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;demo&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;proxy&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;roles&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;aws&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cloudformation&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;aws&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cloudformation&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;was&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;installed&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;successfully&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;extracting&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;aws&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sts&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;to&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Users&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;jmenga&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Source&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;casecommons&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;demo&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;proxy&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;roles&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;aws&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sts&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;aws&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sts&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;was&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;installed&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;successfully&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;5.  Modify the &lt;code&gt;group_vars/all/vars.yml&lt;/code&gt; file, which contains global settings for the playbook:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# Stack Settings&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;cf_stack_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;web&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;proxy&lt;/span&gt;
&lt;span class=&#34;hll&#34;&gt;&lt;span class=&#34;n&#34;&gt;cf_stack_template&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;templates/proxy.yml.j2&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cf_stack_tags&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;org&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;business&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;owner&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Casecommons&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;org&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;business&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Web&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Proxy&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;org&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;business&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;severity&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;High&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;org&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tech&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;environment&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;{{ env }}&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;org&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tech&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;contact&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;pema&lt;/span&gt;&lt;span class=&#34;nd&#34;&gt;@casecommons.org&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;# Stack inputs&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;cf_stack_inputs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;ApplicationImageId&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;{{ config_application_ami }}&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;ApplicationInstanceType&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;{{ config_application_instance_type }}&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;ApplicationAutoscalingDesiredCount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;{{ config_application_desired_count | default(config_az_count) | default(2) | int }}&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;KeyName&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;{{ config_application_keyname }}&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;Environment&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;{{ env }}&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;ProxyImage&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;{{ config_proxy_image }}&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;ProxyImageTag&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;{{ config_proxy_tag }}&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;ProxyDisableWhitelist&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;{{ config_proxy_disable_whitelist | default(false) | string | lower }}&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;ProxyWhitelist&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;quot;{{ config_proxy_whitelist | default(&amp;#39;&amp;#39;) }}&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Notice that we reference the &lt;a href=&#34;https://github.com/casecommons/aws-cloudformation/blob/master/templates/proxy.yml.j2&#34;&gt;templates/proxy.yml.y2 template&lt;/a&gt; that is embedded within the &lt;a href=&#34;https://github.com/casecommons/aws-cloudformation&#34;&gt;aws-cloudformation role&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;We also add a dictionary called &lt;code&gt;cf_stack_inputs&lt;/code&gt;, which provides values for input parameters defined in the proxy CloudFormation template.&lt;/p&gt;

&lt;p&gt;Notice that these settings reference environment specific settings prefixed with &lt;code&gt;config_&lt;/code&gt;, which will we need to define in our environment settings.&lt;/p&gt;

&lt;p&gt;7. Remove the local &lt;code&gt;templates&lt;/code&gt; folder, since we are using a template that is embedded within the &lt;code&gt;aws-cloudformation&lt;/code&gt; role:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ rm -rf templates
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;defining-a-new-environment&#34;&gt;Defining a New Environment&lt;/h2&gt;

&lt;p&gt;We will now add a new environment called &lt;strong&gt;demo-resources&lt;/strong&gt; to the playbook, which will be used to create CloudFormation resources in the &lt;strong&gt;demo-resources&lt;/strong&gt; account.&lt;/p&gt;

&lt;p&gt;1. Modify the &lt;code&gt;inventory&lt;/code&gt; file so that it defines a single environment called &lt;strong&gt;demo-resources&lt;/strong&gt;, ensuring you specify &lt;code&gt;ansible_connection=local&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-toml&#34;&gt;[demo-resources]
demo-resources ansible_connection=local
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2. Remove the &lt;code&gt;group_vars/non-prod&lt;/code&gt; environment folder that is included in the starter template:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ rm -rf group_vars/non-prod
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;3. Create a file called &lt;code&gt;group_vars/demo-resources/vars.yml&lt;/code&gt;, which will hold all environment specific configuration for the &lt;strong&gt;demo-resources&lt;/strong&gt; environment:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mkdir -p group_vars/demo-resources
$ touch group_vars/demo-resources/vars.yml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;4. Add the following settings to &lt;code&gt;group_vars/demo-resources/vars.yml&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;# STS role in the target AWS account to assume
sts_role_arn: &amp;quot;arn:aws:iam::160775127577:role/admin&amp;quot;

# Application settings
config_application_keyname: admin
config_application_instance_type: t2.micro
config_application_ami: ami-4662e126
config_az_count: 3
config_log_deletion_policy: Delete

# Proxy settings
config_proxy_image: 160775127577.dkr.ecr.us-west-2.amazonaws.com/casecommons/squid
config_proxy_tag: latest
config_proxy_disable_whitelist: false
config_proxy_whitelist: .demo.cloudhotspot.co
config_proxy_network_mode: host
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here we target the &lt;strong&gt;demo-resources&lt;/strong&gt; account by specifying the &lt;strong&gt;demo-resources&lt;/strong&gt; IAM &lt;strong&gt;admin&lt;/strong&gt; role in the &lt;code&gt;sts_role_arn&lt;/code&gt; variable, whilst the remaining settings configure the proxy template:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;config_application_keyname&lt;/code&gt; - specifies the name of the EC2 key pair that ECS container instances will be created with.  Notice this matches the name of the &lt;a href=&#34;https://casecommons.github.io/aws-docs/web-proxy/#creating-an-ec2-key-pair&#34;&gt;EC2 key pair created earlier&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;config_application_instance_type&lt;/code&gt; - specifies the EC2 instance type for the ECS container instances that will be created.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;config_application_ami&lt;/code&gt; - specifies the AMI ID of the image used to create the ECS container instances.  Notice this matches the ID of the &lt;a href=&#34;https://casecommons.github.io/aws-docs/web-proxy/#creating-an-ecs-ami&#34;&gt;AMI created earlier&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;config_az_count&lt;/code&gt; - specifies the number of availability zones to place ECS conatiner instances into.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;config_log_deletion_policy&lt;/code&gt; - specifies whether to &amp;ldquo;Delete&amp;rdquo; or &amp;ldquo;Retain&amp;rdquo; CloudWatch log groups when the stack is destroyed.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;config_proxy_image&lt;/code&gt; - specifies the Docker image used to run the squid proxy containers.  Notice this matches the image created in &lt;a href=&#34;https://casecommons.github.io/aws-docs/ecr-resources/#publishing-docker-images&#34;&gt;EC2 Container Registry Resources&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;config_proxy_tag&lt;/code&gt; - specifies the Docker image tag used to run the squid proxy containers.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;config_proxy_disable_whitelist&lt;/code&gt; - disables the web proxy whitelist when set to &lt;code&gt;true&lt;/code&gt;.  The default setting is &lt;code&gt;false&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;config_proxy_whitelist&lt;/code&gt; - defines domains that will be added to the web proxy whitelist.  Here we add &lt;code&gt;.demo.cloudhotspot.co&lt;/code&gt;, which means any host in &lt;code&gt;*.demo.cloudhotspot.co&lt;/code&gt; will be whitelisted.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;config_proxy_network_mode&lt;/code&gt; - configures the Docker networking mode - in this example it is set to &lt;code&gt;host&lt;/code&gt;, meaning the squid container will share the ECS container instance operating system network stack.&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&#34;admonition note&#34;&gt;
&lt;p class=&#34;admonition-title&#34;&gt;Note&lt;/p&gt;
&lt;p&gt;The squid Docker image created in &lt;a href=&#34;https://casecommons.github.io/aws-docs/ecr-resources/#publishing-docker-images&#34;&gt;EC2 Container Registry Resources&lt;/a&gt; includes a whitelist that only permits access to AWS service API endpoints. See &lt;a href=&#34;https://github.com/Casecommons/docker-squid#squid-whitelist&#34;&gt;https://github.com/Casecommons/docker-squid#squid-whitelist&lt;/a&gt; for details on the default whitelist.&lt;/p&gt;
&lt;/div&gt;

&lt;h2 id=&#34;running-the-playbook&#34;&gt;Running the Playbook&lt;/h2&gt;

&lt;p&gt;Now that we&amp;rsquo;ve defined environment settings for the &lt;strong&gt;demo-resources&lt;/strong&gt; environment, let&amp;rsquo;s run the playbook to create ECR repository resources for the environment.&lt;/p&gt;

&lt;p&gt;1. Ensure your local AWS environment is configured to target the &lt;strong&gt;demo-resources&lt;/strong&gt; account:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ export AWS_PROFILE=demo-resources-admin
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2. Run the Ansible playbook targeting the &lt;code&gt;demo-resources&lt;/code&gt; environment as demonstrated below:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span&gt;&lt;/span&gt;$ ansible-playbook site.yml -e &lt;span class=&#34;nv&#34;&gt;env&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;demo-resources

PLAY &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;Assume Role&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; *************************************************************

TASK &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;aws-sts : set_fact&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; ******************************************************
ok: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;demo-resources&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;

TASK &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;aws-sts : checking &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; sts functions are sts_disabled&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; ********************
skipping: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;demo-resources&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;

TASK &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;aws-sts : setting empty sts_session_output result&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; ***********************
skipping: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;demo-resources&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;

TASK &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;aws-sts : setting sts_creds &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; legacy AWS credentials are present &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;e.g. &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; Ansible Tower&lt;span class=&#34;o&#34;&gt;)]&lt;/span&gt; ***
skipping: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;demo-resources&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;

TASK &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;aws-sts : assume sts role&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; ***********************************************
Enter MFA code: ******
ok: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;demo-resources&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
...
...
TASK &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;aws-cloudformation : &lt;span class=&#34;nb&#34;&gt;set&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;local&lt;/span&gt; path fact &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; s3 upload disabled&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; **********
ok: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;demo-resources&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;

TASK &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;aws-cloudformation : configure application stack&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; ************************
...
...
PLAY RECAP *********************************************************************
demo-resources             : &lt;span class=&#34;nv&#34;&gt;ok&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;20&lt;/span&gt;   &lt;span class=&#34;nv&#34;&gt;changed&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;    &lt;span class=&#34;nv&#34;&gt;unreachable&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;    &lt;span class=&#34;nv&#34;&gt;failed&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;3.  The playbook will take approxiately 10 minutes to create the CloudFormation stack and associated resources.  Whilst the CloudFormation stack is being created, you can review the CloudFormation stack that was generated in the &lt;code&gt;build/&amp;lt;timestamp&amp;gt;&lt;/code&gt; folder:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ tree build
build
└── 20170227015822
    ├── web-proxy-config.json
    ├── web-proxy-policy.json
    ├── web-proxy-stack.json
    └── web-proxy-stack.yml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The following shows the &lt;code&gt;web-proxy-stack.yml&lt;/code&gt; file that was generated and uploaded to CloudFormation:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;AWSTemplateFormatVersion: &amp;quot;2010-09-09&amp;quot;

Description: Squid Forward Proxy

Parameters:
  ApplicationImageId:
    Type: String
    Description: Application Amazon Machine Image ID
  ApplicationInstanceType:
    Type: String
    Description: Application EC2 Instance Type
  ApplicationAutoscalingDesiredCount:
    Type: Number
    Description: Application AutoScaling Group Desired Count
    Default: 3      
  ProxyImage:
    Type: String
    Description: Docker Image for Proxy
    Default: 429614120872.dkr.ecr.us-west-2.amazonaws.com/cwds/squid
  ProxyImageTag:
    Type: String
    Description: Docker Image Tag for Proxy
    Default: latest
  ProxyDisableWhitelist:
    Type: String
    Description: Disables whitelist when set to true.  Proxy will operate as an open proxy.
    Default: &amp;quot;false&amp;quot;
    AllowedValues:
    - &amp;quot;true&amp;quot;
    - &amp;quot;false&amp;quot;
  ProxyWhitelist:
    Type: String
    Description: Comma separated list of domains to whitelist
    Default: &amp;quot;&amp;quot;
  KeyName:
    Type: String
    Description: EC2 Key Pair for SSH Access
  Environment:
    Type: String
    Description: Stack Environment
Resources:
  ProxyDnsRecord:
    Type: &amp;quot;AWS::Route53::RecordSet&amp;quot;
    Properties:
      Name:
        Fn::Join: [&amp;quot;&amp;quot;, [ &amp;quot;proxy.&amp;quot;, &amp;quot;Fn::ImportValue&amp;quot;: &amp;quot;DefaultVpcDomain&amp;quot; ] ]
      TTL: &amp;quot;300&amp;quot;
      HostedZoneName:
        Fn::Join: [&amp;quot;&amp;quot;, [ &amp;quot;Fn::ImportValue&amp;quot;: &amp;quot;DefaultVpcDomain&amp;quot;, &amp;quot;.&amp;quot; ] ]
      Type: &amp;quot;CNAME&amp;quot;
      Comment: 
        Fn::Sub: &amp;quot;Forward Proxy - ${Environment}&amp;quot;
      ResourceRecords:
        - Fn::Sub: &amp;quot;${ApplicationLoadBalancer.DNSName}&amp;quot;
  ApplicationLoadBalancer:
    Type : &amp;quot;AWS::ElasticLoadBalancing::LoadBalancer&amp;quot;
    Properties:
      Scheme: &amp;quot;internal&amp;quot;
      SecurityGroups:
        - Ref: &amp;quot;ApplicationLoadBalancerSecurityGroup&amp;quot;
      Subnets:
        - Fn::ImportValue: &amp;quot;DefaultPublicSubnetA&amp;quot;
        - Fn::ImportValue: &amp;quot;DefaultPublicSubnetB&amp;quot;
        - Fn::ImportValue: &amp;quot;DefaultPublicSubnetC&amp;quot;
      CrossZone: &amp;quot;true&amp;quot;
      ConnectionSettings:
        IdleTimeout: 120
      ConnectionDrainingPolicy:
        Enabled: &amp;quot;true&amp;quot;
        Timeout: 120
      Listeners:
        - LoadBalancerPort: &amp;quot;3128&amp;quot;
          InstancePort: &amp;quot;3128&amp;quot;
          Protocol: &amp;quot;tcp&amp;quot;
      Tags:
        - Key: Name
          Value:
            Fn::Sub: ${AWS::StackName}-${Environment}-elb
  ApplicationLoadBalancerSecurityGroup:
    Type: &amp;quot;AWS::EC2::SecurityGroup&amp;quot;
    Properties:
      VpcId:
        Fn::ImportValue: &amp;quot;DefaultVpcId&amp;quot;
      GroupDescription: &amp;quot;Proxy Load Balancer Security Group&amp;quot;
      SecurityGroupIngress:
        - IpProtocol: &amp;quot;tcp&amp;quot;
          FromPort: 3128
          ToPort: 3128
          CidrIp:
            Fn::ImportValue: &amp;quot;DefaultVpcCidr&amp;quot;
  ApplicationLoadBalancerToAutoscalingIngressTCP3128:
    Type: &amp;quot;AWS::EC2::SecurityGroupIngress&amp;quot;
    Properties:
      IpProtocol: &amp;quot;tcp&amp;quot;
      FromPort: 3128
      ToPort: 3128
      GroupId: { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationAutoscalingSecurityGroup&amp;quot; }
      SourceSecurityGroupId: { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationLoadBalancerSecurityGroup&amp;quot; }
  ApplicationLoadBalancerToAutoscalingEgressTCP3128:
    Type: &amp;quot;AWS::EC2::SecurityGroupEgress&amp;quot;
    Properties:
      IpProtocol: &amp;quot;tcp&amp;quot;
      FromPort: 3128
      ToPort: 3128
      GroupId: { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationLoadBalancerSecurityGroup&amp;quot; }
      DestinationSecurityGroupId: { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationAutoscalingSecurityGroup&amp;quot; }
  ApplicationAutoscaling:
    Type: &amp;quot;AWS::AutoScaling::AutoScalingGroup&amp;quot;
    DependsOn:
      - DmesgLogGroup
      - DockerLogGroup
      - EcsAgentLogGroup
      - EcsInitLogGroup
      - MessagesLogGroup
    CreationPolicy:
      ResourceSignal:
        Count: { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationAutoscalingDesiredCount&amp;quot;}
        Timeout: &amp;quot;PT15M&amp;quot;
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationAutoscalingDesiredCount&amp;quot;}
        MinSuccessfulInstancesPercent: &amp;quot;100&amp;quot;
        WaitOnResourceSignals: &amp;quot;true&amp;quot;
        PauseTime: &amp;quot;PT15M&amp;quot;
    Properties:
      VPCZoneIdentifier:
        - Fn::ImportValue: &amp;quot;DefaultPublicSubnetA&amp;quot;
        - Fn::ImportValue: &amp;quot;DefaultPublicSubnetB&amp;quot;
        - Fn::ImportValue: &amp;quot;DefaultPublicSubnetC&amp;quot;
      LaunchConfigurationName: { &amp;quot;Ref&amp;quot; : &amp;quot;ApplicationAutoscalingLaunchConfiguration&amp;quot; }
      MinSize: &amp;quot;0&amp;quot;
      MaxSize: &amp;quot;4&amp;quot;
      DesiredCapacity: { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationAutoscalingDesiredCount&amp;quot; }
      Tags:
        - Key: Name
          Value:
            Fn::Sub: ${AWS::StackName}-instance
          PropagateAtLaunch: &amp;quot;true&amp;quot;
  ApplicationAutoscalingLaunchConfiguration:
    Type: &amp;quot;AWS::AutoScaling::LaunchConfiguration&amp;quot;
    Metadata:
      AWS::CloudFormation::Init:
        config:
          commands:
            10_first_run:
              command: &amp;quot;sh firstrun.sh&amp;quot;
              env:
                STACK_NAME: { &amp;quot;Ref&amp;quot;: &amp;quot;AWS::StackName&amp;quot; }
                AUTOSCALING_GROUP: &amp;quot;ApplicationAutoscaling&amp;quot;
                AWS_DEFAULT_REGION: { &amp;quot;Ref&amp;quot;: &amp;quot;AWS::Region&amp;quot; }
                ECS_CLUSTER: { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationCluster&amp;quot; }
                DOCKER_NETWORK_MODE: &amp;quot;host&amp;quot;
              cwd: &amp;quot;/home/ec2-user/&amp;quot;
          files:
            /etc/ecs/ecs.config:
              content: 
                Fn::Sub: &amp;quot;ECS_CLUSTER=${ApplicationCluster}\n&amp;quot;
    Properties:
      ImageId: { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationImageId&amp;quot; }
      InstanceType: { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationInstanceType&amp;quot; }
      AssociatePublicIpAddress: &amp;quot;true&amp;quot;
      IamInstanceProfile: { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationAutoscalingInstanceProfile&amp;quot; }
      KeyName: { &amp;quot;Ref&amp;quot;: &amp;quot;KeyName&amp;quot; }
      SecurityGroups:
        - Ref: &amp;quot;ApplicationAutoscalingSecurityGroup&amp;quot;
      UserData: 
        Fn::Base64:
          Fn::Join: [&amp;quot;\n&amp;quot;, [
            &amp;quot;#!/bin/bash&amp;quot;,
            &amp;quot;set -e&amp;quot;,
            &amp;quot;Fn::Sub&amp;quot;: &amp;quot;/opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource ApplicationAutoscalingLaunchConfiguration --region ${AWS::Region}&amp;quot;,
            &amp;quot;Fn::Sub&amp;quot;: &amp;quot;/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource ApplicationAutoscaling --region ${AWS::Region}&amp;quot;
          ] ]
  ApplicationAutoscalingSecurityGroup:
    Type: &amp;quot;AWS::EC2::SecurityGroup&amp;quot;
    Properties:
      VpcId:
        Fn::ImportValue: &amp;quot;DefaultVpcId&amp;quot;
      GroupDescription: &amp;quot;Proxy Security Group&amp;quot;
      SecurityGroupIngress:
        - IpProtocol: &amp;quot;tcp&amp;quot;
          FromPort: 22
          ToPort: 22
          CidrIp:
            Fn::ImportValue: &amp;quot;DefaultManagementSubnetACidr&amp;quot;
        - IpProtocol: &amp;quot;tcp&amp;quot;
          FromPort: 22
          ToPort: 22
          CidrIp:
            Fn::ImportValue: &amp;quot;DefaultManagementSubnetBCidr&amp;quot;
      SecurityGroupEgress:
        - IpProtocol: &amp;quot;tcp&amp;quot;
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: &amp;quot;tcp&amp;quot;
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: &amp;quot;udp&amp;quot;
          FromPort: 53
          ToPort: 53
          CidrIp:
            Fn::Join: [&amp;quot;&amp;quot;, [
              &amp;quot;Fn::ImportValue&amp;quot;: &amp;quot;DefaultVpcDnsServer&amp;quot;, &amp;quot;/32&amp;quot;
            ] ]
        - IpProtocol: &amp;quot;udp&amp;quot;
          FromPort: 123
          ToPort: 123
          CidrIp: 0.0.0.0/0
  ApplicationAutoscalingRole:
    Type: &amp;quot;AWS::IAM::Role&amp;quot;
    Properties:
      AssumeRolePolicyDocument:
        Version: &amp;quot;2012-10-17&amp;quot;
        Statement:
          - Effect: &amp;quot;Allow&amp;quot;
            Principal:
              Service: [ &amp;quot;ec2.amazonaws.com&amp;quot; ]
            Action: [ &amp;quot;sts:AssumeRole&amp;quot; ]
      Path: &amp;quot;/&amp;quot;
      ManagedPolicyArns: []
      Policies:
        - {&amp;quot;PolicyName&amp;quot;: &amp;quot;CloudWatchLogs&amp;quot;, &amp;quot;PolicyDocument&amp;quot;: {&amp;quot;Version&amp;quot;: &amp;quot;2012-10-17&amp;quot;, &amp;quot;Statement&amp;quot;: [{&amp;quot;Action&amp;quot;: [&amp;quot;logs:CreateLogGroup&amp;quot;, &amp;quot;logs:CreateLogStream&amp;quot;, &amp;quot;logs:PutLogEvents&amp;quot;, &amp;quot;logs:DescribeLogStreams&amp;quot;], &amp;quot;Resource&amp;quot;: {&amp;quot;Fn::Sub&amp;quot;: &amp;quot;arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${AWS::StackName}*&amp;quot;}, &amp;quot;Effect&amp;quot;: &amp;quot;Allow&amp;quot;}]}}
        - PolicyName: &amp;quot;EC2ContainerInstancePolicy&amp;quot;
          PolicyDocument:
            Statement:
              - Effect: &amp;quot;Allow&amp;quot;
                Action:
                  - &amp;quot;ecs:RegisterContainerInstance&amp;quot;
                  - &amp;quot;ecs:DeregisterContainerInstance&amp;quot;
                Resource: 
                  Fn::Sub: &amp;quot;arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:cluster/${ApplicationCluster}&amp;quot;
              - Effect: &amp;quot;Allow&amp;quot;
                Action:
                  - &amp;quot;ecs:DiscoverPollEndpoint&amp;quot;
                  - &amp;quot;ecs:Submit*&amp;quot;
                  - &amp;quot;ecs:Poll&amp;quot;
                  - &amp;quot;ecs:StartTelemetrySession&amp;quot;
                Resource: &amp;quot;*&amp;quot;
              - Effect: &amp;quot;Allow&amp;quot;
                Action: 
                  - &amp;quot;ecr:BatchCheckLayerAvailability&amp;quot;
                  - &amp;quot;ecr:BatchGetImage&amp;quot;
                  - &amp;quot;ecr:GetDownloadUrlForLayer&amp;quot;
                  - &amp;quot;ecr:GetAuthorizationToken&amp;quot;
                Resource: &amp;quot;*&amp;quot;
  ApplicationAutoscalingInstanceProfile:
    Type: &amp;quot;AWS::IAM::InstanceProfile&amp;quot;
    Properties:
      Path: &amp;quot;/&amp;quot;
      Roles: [ { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationAutoscalingRole&amp;quot; } ]
  ApplicationCluster:
    Type: &amp;quot;AWS::ECS::Cluster&amp;quot;
  ApplicationTaskDefinition:
    Type: &amp;quot;AWS::ECS::TaskDefinition&amp;quot;
    Properties:
      NetworkMode: &amp;quot;host&amp;quot;
      ContainerDefinitions:
      - Name: squid
        Image:
          Fn::Sub: ${ProxyImage}:${ProxyImageTag}
        Memory: 995
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: 
              Fn::Sub: ${AWS::StackName}/ecs/ProxyService/squid
            awslogs-region: { &amp;quot;Ref&amp;quot;: &amp;quot;AWS::Region&amp;quot; }
        PortMappings:
          - ContainerPort: 3128
            Protocol: tcp
        Environment:
        - Name: NO_WHITELIST
          Value: { &amp;quot;Ref&amp;quot;: &amp;quot;ProxyDisableWhitelist&amp;quot; }
        - Name: SQUID_WHITELIST
          Value: { &amp;quot;Ref&amp;quot;: &amp;quot;ProxyWhitelist&amp;quot; }
  ProxyService:
    Type: &amp;quot;AWS::ECS::Service&amp;quot;
    DependsOn: 
      - ApplicationAutoscaling
      - ProxyServiceLogGroup
    Properties:
      Cluster: { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationCluster&amp;quot; }
      TaskDefinition: { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationTaskDefinition&amp;quot; }
      DesiredCount: { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationAutoscalingDesiredCount&amp;quot;}
      DeploymentConfiguration:
          MinimumHealthyPercent: 50
          MaximumPercent: 200
      LoadBalancers:
        - ContainerName: &amp;quot;squid&amp;quot;
          ContainerPort: &amp;quot;3128&amp;quot;
          LoadBalancerName: { &amp;quot;Ref&amp;quot;: &amp;quot;ApplicationLoadBalancer&amp;quot; }
      Role: { &amp;quot;Ref&amp;quot;: &amp;quot;EcsServiceRole&amp;quot; }
  EcsServiceRole:
    Type: &amp;quot;AWS::IAM::Role&amp;quot;
    Properties:
      AssumeRolePolicyDocument:
        Version: &amp;quot;2012-10-17&amp;quot;
        Statement:
          - Effect: &amp;quot;Allow&amp;quot;
            Principal: 
              Service: [ &amp;quot;ecs.amazonaws.com&amp;quot; ]
            Action: [ &amp;quot;sts:AssumeRole&amp;quot; ]
      Path: &amp;quot;/&amp;quot;
      ManagedPolicyArns:
        - &amp;quot;arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceRole&amp;quot;
  DmesgLogGroup:
    Type: &amp;quot;AWS::Logs::LogGroup&amp;quot;
    DeletionPolicy: &amp;quot;Delete&amp;quot;
    Properties:
      LogGroupName: 
        Fn::Sub: ${AWS::StackName}/ec2/ApplicationAutoscaling/var/log/dmesg
      RetentionInDays: 30
  DockerLogGroup:
    Type: &amp;quot;AWS::Logs::LogGroup&amp;quot;
    DeletionPolicy: &amp;quot;Delete&amp;quot;
    Properties:
      LogGroupName: 
        Fn::Sub: ${AWS::StackName}/ec2/ApplicationAutoscaling/var/log/docker
      RetentionInDays: 30
  EcsAgentLogGroup:
    Type: &amp;quot;AWS::Logs::LogGroup&amp;quot;
    DeletionPolicy: &amp;quot;Delete&amp;quot;
    Properties:
      LogGroupName: 
        Fn::Sub: ${AWS::StackName}/ec2/ApplicationAutoscaling/var/log/ecs/ecs-agent
      RetentionInDays: 30
  EcsInitLogGroup:
    Type: &amp;quot;AWS::Logs::LogGroup&amp;quot;
    DeletionPolicy: &amp;quot;Delete&amp;quot;
    Properties:
      LogGroupName: 
        Fn::Sub: ${AWS::StackName}/ec2/ApplicationAutoscaling/var/log/ecs/ecs-init
      RetentionInDays: 30
  MessagesLogGroup:
    Type: &amp;quot;AWS::Logs::LogGroup&amp;quot;
    DeletionPolicy: &amp;quot;Delete&amp;quot;
    Properties:
      LogGroupName: 
        Fn::Sub: ${AWS::StackName}/ec2/ApplicationAutoscaling/var/log/messages
      RetentionInDays: 30
  ProxyServiceLogGroup:
    Type: &amp;quot;AWS::Logs::LogGroup&amp;quot;
    DeletionPolicy: &amp;quot;Delete&amp;quot;
    Properties:
      LogGroupName:
        Fn::Sub: ${AWS::StackName}/ecs/ProxyService/squid
      RetentionInDays: 30
   
Outputs:
  ProxyURL:
    Description: &amp;quot;Squid Proxy URL&amp;quot;
    Value:
      Fn::Join: [&amp;quot;&amp;quot;, [
        &amp;quot;http://proxy.&amp;quot;,
        &amp;quot;Fn::ImportValue&amp;quot;: &amp;quot;DefaultVpcDomain&amp;quot;,
        &amp;quot;:3128&amp;quot;
      ] ]
    Export:
      Name: &amp;quot;DefaultProxyURL&amp;quot;
  ProxySecurityGroup:
    Description: &amp;quot;Squid Proxy Security Group&amp;quot;
    Value:
      Ref: ApplicationLoadBalancerSecurityGroup
    Export:
      Name: &amp;quot;DefaultProxySecurityGroup&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;4. Once the playbook execution completes successfully, login to the &lt;strong&gt;demo-resources&lt;/strong&gt; account.  You should see a new CloudFormation stack called &lt;code&gt;web-proxy&lt;/code&gt;:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://casecommons.github.io/aws-docs/images/web-proxy.png&#34; alt=&#34;Web Proxy Stack&#34; /&gt;&lt;/p&gt;

&lt;p&gt;5. If you open the ECS dashboard and select &lt;strong&gt;Clusters&lt;/strong&gt;, you can see a single ECS cluster was created:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://casecommons.github.io/aws-docs/images/web-proxy-ecs-cluster.png&#34; alt=&#34;Web Proxy ECS Cluster&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;wrap-up&#34;&gt;Wrap Up&lt;/h2&gt;

&lt;p&gt;We created a web proxy in our &lt;strong&gt;demo-resources&lt;/strong&gt; account, which provides the ability for hosts located on private subnets to be able to communicate securely with AWS APIs.&lt;/p&gt;

&lt;div class=&#34;admonition note&#34;&gt;
&lt;p class=&#34;admonition-title&#34;&gt;Note&lt;/p&gt;
&lt;p&gt;At this point you should commit your changes to the web proxy playbook before continuing.&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
  </channel>
</rss>