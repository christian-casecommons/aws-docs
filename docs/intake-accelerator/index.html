<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Intake Accelerator Stack - AWS CloudFormation Tutorial</title>
    <meta name="generator" content="Hugo 0.18.1" />

    
    <meta name="description" content="AWS CloudFormation Tutorial">
    
    <link rel="canonical" href="https://casecommons.github.io/aws-docs/intake-accelerator/">
    
    <meta name="author" content="Justin Menga">
    

    <meta property="og:url" content="https://casecommons.github.io/aws-docs/intake-accelerator/">
    <meta property="og:title" content="AWS CloudFormation Tutorial">
    <meta property="og:image" content="https://casecommons.github.io/aws-docs/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="AWS CloudFormation Tutorial">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://casecommons.github.io/aws-docs/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://casecommons.github.io/aws-docs/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://casecommons.github.io/aws-docs/fonts/icon.eot');
        src: url('https://casecommons.github.io/aws-docs/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://casecommons.github.io/aws-docs/fonts/icon.woff')
               format('woff'),
             url('https://casecommons.github.io/aws-docs/fonts/icon.ttf')
               format('truetype'),
             url('https://casecommons.github.io/aws-docs/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://casecommons.github.io/aws-docs/stylesheets/application.css">
    <link rel="stylesheet" href="https://casecommons.github.io/aws-docs/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://casecommons.github.io/aws-docs/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://casecommons.github.io/aws-docs/stylesheets/highlight/highlight.css">
    <link rel="stylesheet" href="https://casecommons.github.io/aws-docs/stylesheets/overrides.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu&#43;Mono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://casecommons.github.io/aws-docs/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-red palette-accent-teal">




<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Intake Accelerator Stack
      </div>
    </div>

    
    <div class="button button-twitter" role="button" aria-label="Twitter">
       <a href="https://twitter.com/jmenga" title="@jmenga on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
    </div>
    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/mixja" title="@mixja on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://casecommons.github.io/aws-docs/" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="https://casecommons.github.io/aws-docs/images/logo.png">
        </div>
      
      <div class="name">
        <strong>AWS CloudFormation Tutorial <span class="version">v0.1</span></strong>
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Introduction" href="https://casecommons.github.io/aws-docs/">
	
	Introduction
</a>



  
</li>



<li>
  
    



<a  title="Local Setup" href="https://casecommons.github.io/aws-docs/local-setup/">
	
	Local Setup
</a>



  
</li>



<li>
  
    



<a  title="Security Resources" href="https://casecommons.github.io/aws-docs/security-resources/">
	
	Security Resources
</a>



  
</li>



<li>
  
    



<a  title="CloudFormation Resources" href="https://casecommons.github.io/aws-docs/cloudformation-resources/">
	
	CloudFormation Resources
</a>



  
</li>



<li>
  
    



<a  title="Network Resources" href="https://casecommons.github.io/aws-docs/network-resources/">
	
	Network Resources
</a>



  
</li>



<li>
  
    



<a  title="EC2 Container Registry Resources" href="https://casecommons.github.io/aws-docs/ecr-resources/">
	
	EC2 Container Registry Resources
</a>



  
</li>



<li>
  
    



<a  title="Web Proxy Stack" href="https://casecommons.github.io/aws-docs/web-proxy/">
	
	Web Proxy Stack
</a>



  
</li>



<li>
  
    



<a  title="Intake API Stack" href="https://casecommons.github.io/aws-docs/intake-api/">
	
	Intake API Stack
</a>



  
</li>



<li>
  
    



<a class="current" title="Intake Accelerator Stack" href="https://casecommons.github.io/aws-docs/intake-accelerator/">
	
	Intake Accelerator Stack
</a>


<ul id="scrollspy">
</ul>


  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          
          <li>
            <a href="https://twitter.com/jmenga" target="_blank" title="@jmenga on Twitter">
              @jmenga on Twitter
            </a>
          </li>
          

          
          <li>
            <a href="https://github.com/mixja" target="_blank" title="@mixja on GitHub">
              @mixja on GitHub
            </a>
          </li>
          

          
          <li>
            <a href="mailto:justin.menga@gmail.com" title="Email of justin.menga@gmail.com">
              Contact via email
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Intake Accelerator Stack </h1>

			

<h2 id="introduction">Introduction</h2>

<p>We have established all of the shared resource stacks in our <strong>demo-users</strong> and <strong>demo-resources</strong> accounts, and created the Intake API application stack.</p>

<p>We will now deploy the Intake Accelerator application to our <strong>demo-resources</strong> account, creating a <strong>demo</strong> environment, with the Intake Accelerator application published at <code>https://demo-intake.demo.cloudhotspot.co</code>.</p>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Intake Accelerator stack relies on a number of supporting services and resources that we created in the <a href="https://casecommons.github.io/aws-docs/intake-api/">Intake API Stack section</a> including:</p>

<ul>
<li><a href="https://casecommons.github.io/aws-docs/intake-api/#configuring-dns-delegation">Configuring DNS Delegation</a></li>
<li><a href="https://casecommons.github.io/aws-docs/intake-api/#creating-a-certificate">Creating a Certificate</a></li>
<li><a href="https://casecommons.github.io/aws-docs/intake-api/#creating-an-nginx-image">Creating an Nginx Image</a></li>
<li><a href="https://casecommons.github.io/aws-docs/intake-api/#creating-the-intake-base-image">Creating the Intake Base Image</a></li>
</ul>
</p>
</div>

<h2 id="creating-the-intake-image">Creating the Intake Image</h2>

<p>The Intake Accelerator Docker image needs to be published to the <strong>casecommons/intake</strong> ECR repository, so that it is available to ECS instances when we deploy the CloudFormation stack for running the Intake API application.</p>

<p>1. Clone the Intake application from the following forked repository (<a href="https://github.com/mixja/intake">https://github.com/mixja/intake</a>) to your local environment and ensure you checkout the <strong>production_workflow</strong> branch:</p>

<div class="highlight"><pre><code class="language-make" data-lang="make"><span></span><span class="nf">$ git clone git@github.com</span><span class="o">:</span><span class="n">mixja</span>/<span class="n">intake</span>.<span class="n">git</span>
<span class="err">Cloning</span> <span class="err">into</span> <span class="s1">&#39;intake&#39;</span><span class="err">...</span>
<span class="nf">remote</span><span class="o">:</span> <span class="n">Counting</span> <span class="n">objects</span>: 8913<span class="p">,</span> <span class="n">done</span>.
<span class="nf">remote</span><span class="o">:</span> <span class="n">Compressing</span> <span class="n">objects</span>: 100% (19/19)<span class="p">,</span> <span class="n">done</span>.
<span class="nf">remote</span><span class="o">:</span> <span class="n">Total</span> 8913 (<span class="n">delta</span> 8)<span class="p">,</span> <span class="n">reused</span> 4 (<span class="n">delta</span> 4)<span class="p">,</span> <span class="n">pack</span>-<span class="n">reused</span> 8890
<span class="nf">Receiving objects</span><span class="o">:</span> 100% (8913/8913)<span class="p">,</span> 2.68 <span class="n">MiB</span> <span class="p">|</span> 974.00 <span class="n">KiB</span>/<span class="n">s</span><span class="p">,</span> <span class="n">done</span>.
<span class="nf">Resolving deltas</span><span class="o">:</span> 100% (6329/6329)<span class="p">,</span> <span class="n">done</span>.
<span class="err">$</span> <span class="err">cd</span> <span class="err">intake</span>
<span class="hll"><span class="err">$</span> <span class="err">git</span> <span class="err">checkout</span> <span class="err">production_workflow</span>
</span><span class="err">Branch</span> <span class="err">production_workflow</span> <span class="err">set</span> <span class="err">up</span> <span class="err">to</span> <span class="err">track</span> <span class="err">remote</span> <span class="err">branch</span> <span class="err">production_workflow</span> <span class="err">from</span> <span class="err">origin.</span>
<span class="err">Switched</span> <span class="err">to</span> <span class="err">a</span> <span class="err">new</span> <span class="err">branch</span> <span class="s1">&#39;production_workflow&#39;</span>
</code></pre></div>


<p>2. Open the <code>Makefile</code> at the root of the <strong>intake</strong> repository and modify the highlighted settings:</p>

<div class="highlight"><pre><code class="language-make" data-lang="make"><span></span><span class="c"># Project variables</span>
<span class="nv">PROJECT_NAME</span> <span class="o">?=</span> intake_accelerator
<span class="hll"><span class="nv">ORG_NAME</span> <span class="o">?=</span> casecommons
</span><span class="hll"><span class="nv">REPO_NAME</span> <span class="o">?=</span> intake
</span><span class="hll"><span class="nv">DOCKER_REGISTRY</span> <span class="o">?=</span> <span class="m">160775127577</span>.dkr.ecr.us-west-2.amazonaws.com
</span><span class="hll"><span class="nv">AWS_ACCOUNT_ID</span> <span class="o">?=</span> <span class="m">160775127577</span>
</span><span class="nv">DOCKER_LOGIN_EXPRESSION</span> <span class="o">:=</span> <span class="nb">eval</span> <span class="nv">$$</span><span class="o">(</span>aws ecr get-login --registry-ids <span class="k">$(</span>AWS_ACCOUNT_ID<span class="k">)</span><span class="o">)</span>
<span class="err">...</span>
<span class="err">...</span>
</code></pre></div>


<p>Here we ensure the <code>Makefile</code> settings are configured with the correct Docker registry name (<code>DOCKER_REGISTRY</code>), organization name (<code>ORG_NAME</code>), repository name (<code>REPO_NAME</code>) and AWS account ID (<code>AWS_ACCOUNT_ID</code>).</p>

<p>3. Open the <code>docker/release/Dockerfile</code> file and modify the <code>FROM</code> directive to reference the <strong>intake-base</strong> image you published earlier:</p>

<div class="highlight"><pre><code class="language-make" data-lang="make"><span></span><span class="hll"><span class="err">FROM</span> <span class="err">160775127577.dkr.ecr.us-west-2.amazonaws.com/casecommons/intake-base</span>
</span><span class="err">MAINTAINER</span> <span class="err">Pema</span> <span class="err">Geyleg</span> <span class="err">&lt;pema@casecommons.org&gt;</span>
<span class="nf">HEALTHCHECK --interval=3s --retries=20 CMD ${HEALTHCHECK</span><span class="o">:</span>-<span class="n">curl</span> -<span class="n">fs</span> <span class="n">localhost</span>:${<span class="n">HTTP_PORT</span>:-3000}}
<span class="err">...</span>
<span class="err">...</span>
</code></pre></div>


<p>4. Open the <code>docker/release/docker-compose.yml</code> file and modify the <code>image</code> variable for the <code>nginx</code>, <code>intake-api</code> and <code>intake-api-nginx</code> services to reference the images published to the <strong>demo-resources</strong> EC2 Container Registry:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;2&#39;</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="n">services</span><span class="p">:</span>
<span class="o">...</span>
<span class="o">...</span>
  <span class="n">nginx</span><span class="p">:</span>
<span class="hll">    <span class="n">image</span><span class="p">:</span> <span class="mf">160775127577.</span><span class="n">dkr</span><span class="o">.</span><span class="n">ecr</span><span class="o">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mf">2.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">casecommons</span><span class="o">/</span><span class="n">nginx</span>
</span>    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;${HTTP_PORT}&quot;</span>
<span class="o">...</span>
<span class="o">...</span>
  <span class="n">intake</span><span class="o">-</span><span class="n">api</span><span class="p">:</span>
<span class="hll">    <span class="n">image</span><span class="p">:</span> <span class="mf">160775127577.</span><span class="n">dkr</span><span class="o">.</span><span class="n">ecr</span><span class="o">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mf">2.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">casecommons</span><span class="o">/</span><span class="n">intake</span><span class="o">-</span><span class="n">api</span>
</span>    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">intake</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="n">webroot</span><span class="p">:</span><span class="o">/</span><span class="n">intake_api_prototype</span><span class="o">/</span><span class="n">public</span>
      <span class="o">-</span> <span class="n">intake</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="n">tmp</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span>
<span class="o">...</span>
<span class="o">...</span>
  <span class="n">intake</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="n">nginx</span><span class="p">:</span>
<span class="hll">    <span class="n">image</span><span class="p">:</span> <span class="mf">160775127577.</span><span class="n">dkr</span><span class="o">.</span><span class="n">ecr</span><span class="o">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mf">2.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">casecommons</span><span class="o">/</span><span class="n">nginx</span>
</span>    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;${HTTP_PORT}&quot;</span>
<span class="o">...</span>
<span class="o">...</span>
</code></pre></div>


<p>4. Run the <code>make login</code> command to login to the ECR repository for the <strong>demo-resources</strong> account:</p>

<pre><code class="language-bash">$ export AWS_PROFILE=demo-resources-admin
$ make login
=&gt; Logging in to Docker registry ...
Enter MFA code: *****
Login Succeeded
=&gt; Logged in to Docker registry
</code></pre>

<p>5. Run the <code>make test</code> command, which will run unit tests in a Docker build container:</p>

<pre><code class="language-bash">$ make test
=&gt; Pulling latest images...
Pulling redis (redis:3.0)...
...
...
=&gt; Running tests...
Creating network &quot;intakeacceleratortest_default&quot; with the default driver
Creating intakeacceleratortest_redis_1
Creating intakeacceleratortest_rspec_test_1
Attaching to intakeacceleratortest_rspec_test_1
...
...
javascript_test_1  | TOTAL: 558 SUCCESS
javascript_test_1  | TOTAL: 558 SUCCESS
javascript_test_1  | 01 03 2017 08:57:37.695:WARN [launcher]: Firefox was not killed in 2000 ms, sending SIGKILL.
intakeacceleratortest_javascript_test_1 exited with code 0
=&gt; Testing complete
</code></pre>

<p>6. Run the <code>make build</code> command, which will build a Debian package from the application source and copy it to the local <code>target</code> folder:</p>

<pre><code class="language-bash">$ make build
=&gt; Building images...
Building builder
Step 1/12 : FROM casecommons/ca_intake_base_image:latest
...
...
builder_1          | {:timestamp=&gt;&quot;2017-03-01T09:00:19.538128+0000&quot;, :message=&gt;&quot;Created package&quot;, :path=&gt;&quot;/build_artefacts/intake-accelerator_1.b869606_amd64.deb&quot;}
intakeacceleratortest_builder_1 exited with code 0
=&gt; Copying application artifacts...
=&gt; Build complete
</code></pre>

<p>7. Run the <code>make release</code> command, which will build the release image for the Intake API application, start a minimal production-like environment and run acceptance tests.</p>

<pre><code class="language-bash">$ make release
$ make release
=&gt; Pulling latest images...
Pulling intake-api (160775127577.dkr.ecr.us-west-2.amazonaws.com/casecommons/intake-api:latest)...
latest: Pulling from casecommons/intake-api
Digest: sha256:04cfa51f3d684b0a20132b7d515322816c5d49efccef4eabb9b98e6e03f1e211
...
...
=&gt; Starting Intake API...
Creating intakeaccelerator_intake-api_1
Creating intakeaccelerator_intake-api-nginx_1
=&gt; Starting redis...
Creating intakeaccelerator_redis_1
=&gt; Starting application...
Creating intakeaccelerator_app_1
=&gt; Starting nginx...
Creating intakeaccelerator_nginx_1
=&gt; Application is running at http://172.16.154.128:32801
</code></pre>

<p>8. Run the <code>make tag latest</code> command, which will tag the image with the <code>latest</code> tag:</p>

<pre><code class="language-bash">$ make tag latest
=&gt; Tagging release image with tags latest...
=&gt; Tagging complete
</code></pre>

<p>9. Run the <code>make publish</code> command, which will publish the image to your ECR repository:</p>

<pre><code class="language-bash">$ make publish
=&gt; Publishing release image to 160775127577.dkr.ecr.us-west-2.amazonaws.com/casecommons/intake...
The push refers to a repository [160775127577.dkr.ecr.us-west-2.amazonaws.com/casecommons/intake
250774d98791: Pushed
d6e0c772e63d: Pushed
0eb3fff043d9: Pushed
cc269cc723a3: Pushed
985910e761d0: Pushed
e302f1438372: Pushed
7cebbf491a73: Pushed
ba3d5a81c1e6: Pushed
5d53f93940f5: Pushed
38dcb92de9f2: Pushed
a2ae92ffcd29: Pushed
latest: digest: sha256:7c645b33cd0d8d13cd7450b4653aa1f96336dadc76c363f8d4a52dd193134a05 size: 2628
=&gt; Publish complete
</code></pre>

<p>10. Run the <code>make clean</code> command to clean up the local Docker environment.</p>

<pre><code class="language-bash">$ make clean
=&gt; Destroying development environment...
...
...
=&gt; Removing dangling images...
=&gt; Clean complete
</code></pre>

<p>11. In the AWS console under <strong>ECS &gt; Repositories</strong>, you should now be able to see your newly published image in the <strong>casecommons/intake</strong> repository:</p>

<p><img src="https://casecommons.github.io/aws-docs/images/intake-image.png" alt="Intake API Image" /></p>

<h2 id="installing-the-playbook">Installing the Playbook</h2>

<p>We now have all the supporting pieces in place to deploy the Intake Accelerator application stack to the <strong>demo resources</strong> account.  Instead of creating a new playbook as we have done previously in this tutorial, we will instead clone an existing playbook and add a new environment called <strong>demo-resources</strong> to the playbook.</p>

<p>1. Clone the <a href="https://github.com/casecommons/intake-accelerator-aws">Intake Accelerator AWS project</a> to your local environment.</p>

<pre><code class="language-bash">$ git clone git@github.com:Casecommons/intake-accelerator-aws.git
  Cloning into 'intake-accelerator-aws'...
  remote: Counting objects: 165, done.
  remote: Compressing objects: 100% (9/9), done.
  remote: Total 165 (delta 1), reused 0 (delta 0), pack-reused 152
  Receiving objects: 100% (165/165), 30.07 KiB | 0 bytes/s, done.
  Resolving deltas: 100% (62/62), done.
$ cd intake-accelerator-aws
</code></pre>

<p>3.  Install the required Ansible roles for the playbook using the <code>ansible-galaxy</code> command as demonstrated below:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="err">$</span> <span class="n">ansible</span><span class="o">-</span><span class="n">galaxy</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">roles</span><span class="o">/</span><span class="n">requirements</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">force</span>
<span class="o">-</span> <span class="n">extracting</span> <span class="n">aws</span><span class="o">-</span><span class="n">cloudformation</span> <span class="n">to</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">jmenga</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">casecommons</span><span class="o">/</span><span class="n">temp</span><span class="o">/</span><span class="n">roles</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">cloudformation</span>
<span class="o">-</span> <span class="n">aws</span><span class="o">-</span><span class="n">cloudformation</span> <span class="n">was</span> <span class="n">installed</span> <span class="n">successfully</span>
<span class="o">-</span> <span class="n">extracting</span> <span class="n">aws</span><span class="o">-</span><span class="n">sts</span> <span class="n">to</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">jmenga</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">casecommons</span><span class="o">/</span><span class="n">temp</span><span class="o">/</span><span class="n">roles</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">sts</span>
<span class="o">-</span> <span class="n">aws</span><span class="o">-</span><span class="n">sts</span> <span class="n">was</span> <span class="n">installed</span> <span class="n">successfully</span>
<span class="o">-</span> <span class="n">extracting</span> <span class="n">aws</span><span class="o">-</span><span class="n">ecs</span><span class="o">-</span><span class="n">tasks</span> <span class="n">to</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">jmenga</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">casecommons</span><span class="o">/</span><span class="n">temp</span><span class="o">/</span><span class="n">roles</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">ecs</span><span class="o">-</span><span class="n">tasks</span>
<span class="o">-</span> <span class="n">aws</span><span class="o">-</span><span class="n">ecs</span><span class="o">-</span><span class="n">tasks</span> <span class="n">was</span> <span class="n">installed</span> <span class="n">successfully</span>
</code></pre></div>


<p>5.  Review the <code>group_vars/all/vars.yml</code> file, which contains global settings for the playbook:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">cf_stack_name</span><span class="p">:</span> <span class="s2">&quot;{{ &#39;intake-accelerator-&#39; + env }}&quot;</span>
<span class="n">cf_stack_tags</span><span class="p">:</span>
  <span class="n">org</span><span class="p">:</span><span class="n">business</span><span class="p">:</span><span class="n">owner</span><span class="p">:</span> <span class="n">CA</span> <span class="n">Intake</span>
  <span class="n">org</span><span class="p">:</span><span class="n">business</span><span class="p">:</span><span class="n">product</span><span class="p">:</span> <span class="n">Intake</span> <span class="n">Accelerator</span>
  <span class="n">org</span><span class="p">:</span><span class="n">business</span><span class="p">:</span><span class="n">severity</span><span class="p">:</span> <span class="n">High</span>
  <span class="n">org</span><span class="p">:</span><span class="n">tech</span><span class="p">:</span><span class="n">environment</span><span class="p">:</span> <span class="s2">&quot;{{ env }}&quot;</span>
  <span class="n">org</span><span class="p">:</span><span class="n">tech</span><span class="p">:</span><span class="n">contact</span><span class="p">:</span> <span class="n">pema</span><span class="nd">@casecommons.org</span>

<span class="n">cf_stack_inputs</span><span class="p">:</span>
  <span class="n">ApplicationAutoscalingDesiredCount</span><span class="p">:</span> <span class="s2">&quot;{{ config_application_desired_count }}&quot;</span>
  <span class="n">ApplicationAMI</span><span class="p">:</span> <span class="s2">&quot;{{ config_application_ami }}&quot;</span>
  <span class="n">ApplicationInstanceType</span><span class="p">:</span> <span class="s2">&quot;{{ config_application_instance_type }}&quot;</span>
  <span class="n">ApplicationLoadBalancerPort</span><span class="p">:</span> <span class="s2">&quot;{{ config_application_frontend_port }}&quot;</span>
  <span class="n">ApplicationPort</span><span class="p">:</span> <span class="s2">&quot;{{ config_application_port }}&quot;</span>
  <span class="n">ApplicationKeyName</span><span class="p">:</span> <span class="s2">&quot;{{ config_application_keyname }}&quot;</span>
  <span class="n">ApplicationDockerImage</span><span class="p">:</span> <span class="s2">&quot;{{ config_application_image }}&quot;</span>
  <span class="n">ApplicationDockerImageTag</span><span class="p">:</span> <span class="s2">&quot;{{ config_application_tag }}&quot;</span>
  <span class="n">ApplicationApiUrl</span><span class="p">:</span> <span class="s2">&quot;{{ config_application_api_url }}&quot;</span>
  <span class="n">ApplicationAuthentication</span><span class="p">:</span> <span class="s2">&quot;{{ config_application_authentication }}&quot;</span>
  <span class="n">ApplicationAuthenticationUrl</span><span class="p">:</span> <span class="s2">&quot;{{ config_application_authentication_url }}&quot;</span>
  <span class="n">ApplicationDomain</span><span class="p">:</span> <span class="s2">&quot;{{ config_application_domain }}&quot;</span>
  <span class="n">Environment</span><span class="p">:</span> <span class="s2">&quot;{{ env }}&quot;</span>
  <span class="n">LogRetention</span><span class="p">:</span> <span class="s2">&quot;{{ config_log_retention }}&quot;</span>
  <span class="n">NginxDockerImage</span><span class="p">:</span> <span class="s2">&quot;{{ config_nginx_image }}&quot;</span>
  <span class="n">NginxDockerImageTag</span><span class="p">:</span> <span class="s2">&quot;{{ config_nginx_tag }}&quot;</span>
  <span class="n">SecretKeyBaseCipher</span><span class="p">:</span> <span class="s2">&quot;{{ config_application_secret_key_base }}&quot;</span>
</code></pre></div>


<p>You can see this stack has many different stack inputs, which revolve around application settings.</p>

<p>One thing to note is that the <code>cf_stack_template</code> variable is not defined - this variable defaults to the path <code>templates/stack.yml.j2</code> in the local playbook, and you will find this playbook includes a large CloudFormation template in this location.</p>

<h2 id="defining-a-new-environment">Defining a New Environment</h2>

<p>We will now add a new environment called <strong>demo</strong> to the playbook, which will be used to create the Intake API application stack in the <strong>demo-resources</strong> account.</p>

<p>1. Modify the <code>inventory</code> file so that it defines a new environment called <strong>demo</strong>, ensuring you specify <code>ansible_connection=local</code>:</p>

<div class="highlight"><pre><code class="language-ini" data-lang="ini"><span></span><span class="k">[dev]</span>
<span class="na">dev ansible_connection</span><span class="o">=</span><span class="s">local</span>

<span class="hll"><span class="k">[demo]</span>
</span><span class="hll"><span class="na">demo ansible_connection</span><span class="o">=</span><span class="s">local</span>
</span><span class="na">```</span>
</code></pre></div>


<p>2. Create a file called <code>group_vars/demo/vars.yml</code>, which will hold all environment specific configuration for the <strong>demo</strong> environment:</p>

<pre><code class="language-bash">$ mkdir -p group_vars/demo
$ touch group_vars/demo/vars.yml
</code></pre>

<p>4. Copy the existing settings from <code>group_vars/dev/vars.yml</code> to <code>group_vars/demo/vars.yml</code> and modify as shown below:</p>

<div class="highlight"><pre><code class="language-ini" data-lang="ini"><span></span><span class="c1"># STS settings</span>
<span class="hll"><span class="na">sts_role_arn: arn:aws:iam::160775127577:role/admin</span>
</span>
<span class="c1"># Application settings</span>
<span class="hll"><span class="na">config_application_keyname: admin</span>
</span><span class="na">config_application_instance_type: t2.micro</span>
<span class="na">config_application_desired_count: 2</span>
<span class="hll"><span class="na">config_application_ami: ami-4662e126</span>
</span><span class="hll"><span class="na">config_application_image: 160775127577.dkr.ecr.us-west-2.amazonaws.com/casecommons/intake</span>
</span><span class="na">config_application_tag: latest</span>
<span class="na">config_application_frontend_port: 443</span>
<span class="na">config_application_port: 3000</span>
<span class="hll"><span class="na">config_application_secret_key_base: xxxxx</span>
</span><span class="hll"><span class="na">config_application_api_url: https://demo-intake-api.demo.cloudhotspot.co/</span>
</span><span class="na">config_application_authentication: &quot;true&quot;</span>
<span class="na">config_application_authentication_url: http://perry.intake.cwds.tabordasolutions.net</span>
<span class="hll"><span class="na">config_application_domain: demo.cloudhotspot.co</span>
</span>
<span class="c1"># Nginx settings</span>
<span class="hll"><span class="na">config_nginx_image: 160775127577.dkr.ecr.us-west-2.amazonaws.com/casecommons/nginx</span>
</span><span class="na">config_nginx_tag: latest</span>

<span class="c1"># Load balancer settings</span>
<span class="na">config_lb_certificate_arn:</span>
<span class="hll">  <span class="na">Fn::ImportValue: DemoCloudhotspotCoCertificateArn</span>
</span>
<span class="c1"># Log settings</span>
<span class="na">config_log_retention: 30</span>
<span class="na">config_log_deletion_policy: Delete</span>
</code></pre></div>


<p>Here we target the <strong>demo-resources</strong> account by specifying the <strong>demo-resources</strong> IAM <strong>admin</strong> role in the <code>sts_role_arn</code> variable, whilst the remaining settings configure the Intake APi application stack specify to the <strong>demo-resources</strong> template account:</p>

<ul>
<li><code>config_application_keyname</code> - specifies the name of the EC2 key pair that ECS container instances will be created with.  Notice this matches the name of the <a href="https://casecommons.github.io/aws-docs/web-proxy/#creating-an-ec2-key-pair">EC2 key pair created earlier</a>.</li>
<li><code>config_application_ami</code> - specifies the AMI ID of the image used to create the ECS container instances.  Notice this matches the ID of the <a href="https://casecommons.github.io/aws-docs/web-proxy/#creating-an-ecs-ami">AMI created earlier</a></li>
<li><code>config_application_image</code> - specifies the Docker image used to run the Intake Accelerator application containers.  Notice this matches the <a href="https://casecommons.github.io/aws-docs/intake-accelerator/#creating-the-intake-image">image we created earlier</a></li>
<li><code>config_application_secret_key_base</code> - an encrypted application setting that provides cryptographic material for an application secret key.  We will securely generate an encrypted value for this setting shortly.</li>
<li><code>config_application_api_url</code> - specifies the URL of the Intake API endpoint that the Intake Accelerator application should connect to.</li>
<li><code>config_application_domain</code> - specifies the base domain that our application will be served from.</li>
<li><code>config_nginx_image</code> - specifies the Docker image used to run the Intake API Nginx containers.  Notice this matches the <a href="https://casecommons.github.io/aws-docs/intake-api/#creating-an-nginx-image">image we created earlier</a></li>
<li><code>config_lb_certificate_arn</code> - specifies the ARN of the AWS certificate manager (ACM) certificate to serve from the application load balancer for HTTPS connections.  Notice that we can specify this setting as a CloudFormation instrinsic function, as the template is configured to cast the configured value to a JSON object.  The intrinsic function imports the CloudFormation export <code>DemoCloudhotspotCoCertificateArn</code>, which was created earlier when we <a href="https://casecommons.github.io/aws-docs/intake-api/#creating-a-certificate">created the certificate</a> in the security resources playbook.</li>
</ul>

<h2 id="creating-secrets-using-kms">Creating Secrets using KMS</h2>

<p>Our <strong>demo</strong> environment settings include a single setting (<code>config_application_secret_key_base</code>) that we need to generate encrypted values for.</p>

<p>The approach here is to simply use the AWS Key Management Service (KMS) to encrypt the plaintext value of the secret.  We will use the KMS key that was created as part of the <a href="https://casecommons.github.io/aws-docs/cloudformation-resources/">CloudFormation resources</a> stack.</p>

<p>1. In the AWS console, open the <strong>CloudFormation &gt; Exports</strong> from the CloudFormation dashboard.  Copy the <strong>CfnMasterKey</strong> export value, which defines the key ID of the KMS key we will use for encryption.</p>

<p><img src="https://casecommons.github.io/aws-docs/images/cfn-master-key.png" alt="KMS Master Key" /></p>

<p>2. In a local shell configured with an admin profile targetting the <strong>demo resources</strong> account, run the following command to generate ciphertext for the <code>config_application_secret_key_base</code> variable:</p>

<pre><code class="language-bash">$ export AWS_PROFILE=demo-resources-admin
$ aws kms encrypt --key-id 11710b57-c424-4df7-ab3d-20358820edd9 --plaintext $(openssl rand -base64 32)
Enter MFA code: ******
'{
    &quot;KeyId&quot;: &quot;arn:aws:kms:us-west-2:160775127577:key/11710b57-c424-4df7-ab3d-20358820edd9&quot;,
    &quot;CiphertextBlob&quot;: &quot;AQECAHjbSbOZ8FLk7XffvdtrDewDyQKH9bOaMrY6jf+N3si+SQAAAIswgYgGCSqGSIb3DQEHBqB7MHkCAQAwdAYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAxUVkZgkHNkRWRcbtgCARCAR2bG8d33uID+nq01bRjHeNJzsFgTqrOxCoY7LmR+tyVT/3oTAQYePtsJC3Dt9zmOJ4G82Q36X4q0ng5r8YPaj15wp/en0tPY&quot;
}
</code></pre>

<p>3. Copy the <code>CiphertextBlob</code> value from the <code>aws kms encrypt</code> command output and set the <code>config_application_secret_key_base</code> variable in <code>group_vars/demo/vars.yml</code> to this value:</p>

<div class="highlight"><pre><code class="language-ini" data-lang="ini"><span></span><span class="c1"># STS settings</span>
<span class="na">sts_role_arn: arn:aws:iam::160775127577:role/admin</span>

<span class="c1"># Application settings</span>
<span class="na">config_application_keyname: admin</span>
<span class="na">config_application_instance_type: t2.micro</span>
<span class="na">config_application_desired_count: 2</span>
<span class="na">config_application_ami: ami-4662e126</span>
<span class="na">config_application_image: 160775127577.dkr.ecr.us-west-2.amazonaws.com/casecommons/intake</span>
<span class="na">config_application_tag: latest</span>
<span class="na">config_application_frontend_port: 443</span>
<span class="na">config_application_port: 3000</span>
<span class="hll"><span class="na">config_application_secret_key_base: AQECAHjbSbOZ8FLk7XffvdtrDewDyQKH9bOaMrY6jf+N3si+SQAAAIswgYgGCSqGSIb3DQEHBqB7MHkCAQAwdAYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAxUVkZgkHNkRWRcbtgCARCAR2bG8d33uID+nq01bRjHeNJzsFgTqrOxCoY7LmR+tyVT/3oTAQYePtsJC3Dt9zmOJ4G82Q36X4q0ng5r8YPaj15wp/en0tPY</span>
</span><span class="na">config_application_api_url: https://demo-intake-api.demo.cloudhotspot.co/</span>
<span class="na">config_application_authentication: &quot;true&quot;</span>
<span class="na">config_application_authentication_url: http://perry.intake.cwds.tabordasolutions.net</span>
<span class="na">config_application_domain: demo.cloudhotspot.co</span>
<span class="na">...</span>
<span class="na">...</span>
</code></pre></div>


<h2 id="running-the-playbook">Running the Playbook</h2>

<p>Now that we&rsquo;ve defined environment settings for the <strong>demo</strong> environment targeting our <strong>demo-resources</strong> account, let&rsquo;s run the playbook.</p>

<p>1. Ensure your local AWS environment is configured to target the <strong>demo-resources</strong> account:</p>

<pre><code class="language-bash">$ export AWS_PROFILE=demo-resources-admin
</code></pre>

<p>2. Run the Ansible playbook targeting the <code>demo</code> environment as demonstrated below:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ ansible-playbook site.yml -e <span class="nv">env</span><span class="o">=</span>demo

PLAY <span class="o">[</span>Assume Role<span class="o">]</span> *************************************************************

TASK <span class="o">[</span>aws-sts : set_fact<span class="o">]</span> ******************************************************
ok: <span class="o">[</span>demo<span class="o">]</span>

TASK <span class="o">[</span>aws-sts : checking <span class="k">if</span> sts functions are sts_disabled<span class="o">]</span> ********************
skipping: <span class="o">[</span>demo<span class="o">]</span>

TASK <span class="o">[</span>aws-sts : setting empty sts_session_output result<span class="o">]</span> ***********************
skipping: <span class="o">[</span>demo<span class="o">]</span>

TASK <span class="o">[</span>aws-sts : setting sts_creds <span class="k">if</span> legacy AWS credentials are present <span class="o">(</span>e.g. <span class="k">for</span> Ansible Tower<span class="o">)]</span> ***
skipping: <span class="o">[</span>demo<span class="o">]</span>

TASK <span class="o">[</span>aws-sts : assume sts role<span class="o">]</span> ***********************************************
Enter MFA code: ******
ok: <span class="o">[</span>demo<span class="o">]</span>
...
...
TASK <span class="o">[</span>aws-cloudformation : <span class="nb">set</span> <span class="nb">local</span> path fact <span class="k">if</span> s3 upload disabled<span class="o">]</span> **********
ok: <span class="o">[</span>demo<span class="o">]</span>

TASK <span class="o">[</span>aws-cloudformation : configure application stack<span class="o">]</span> ************************
...
...
PLAY RECAP *********************************************************************
demo                       : <span class="nv">ok</span><span class="o">=</span><span class="m">18</span>   <span class="nv">changed</span><span class="o">=</span><span class="m">1</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>
</code></pre></div>


<p>3.  The playbook will take approxiately 10 minutes to create the CloudFormation stack and associated resources.  Whilst the CloudFormation stack is being created, you can review the CloudFormation stack that was generated in the <code>build/&lt;timestamp&gt;</code> folder:</p>

<pre><code class="language-bash">$ tree build
build
└── 20170301224832
    ├── intake-accelerator-demo-config.json
    ├── intake-accelerator-demo-policy.json
    ├── intake-accelerator-demo-stack.json
    └── intake-accelerator-demo-stack.yml
</code></pre>

<p>The following shows the <code>intake-accelerator-demo-stack.yml</code> file that was generated and uploaded to CloudFormation:</p>

<pre><code class="language-python">AWSTemplateFormatVersion: &quot;2010-09-09&quot;

Description: Intake Accelerator - demo

Parameters:
  ApplicationAMI:
    Type: String
    Description: Application Amazon Machine Image ID
  ApplicationInstanceType:
    Type: String
    Description: Application EC2 Instance Type
  ApplicationAutoscalingDesiredCount:
    Type: Number
    Description: Application AutoScaling Group Desired Count
  ApplicationDockerImage:
    Type: String
    Description: Docker Image for Application
  ApplicationDockerImageTag:
    Type: String
    Description: Docker Image Tag for Application
    Default: latest
  ApplicationKeyName:
    Type: String
    Description: EC2 Key Pair for Application SSH Access
  ApplicationLoadBalancerPort:
    Type: Number
    Description: Application Front End HTTP Port
  ApplicationPort:
    Type: Number
    Description: Application HTTP Port
  ApplicationDomain:
    Type: String
    Description: Base public domain of the application URL
  ApplicationCacheFailover:
    Type: String
    Description: Enables/disables Redis cache automatic failover
    AllowedValues:
      - &quot;true&quot;
      - &quot;false&quot;
    Default: &quot;false&quot;
  ApplicationCacheInstanceCount:
    Type: Number
    Description: Number of Redis cache instances
    Default: 1
  ApplicationCacheInstanceType:
    Type: String
    Description: Type of Redis cache instance
    Default: cache.t2.micro
  ApplicationCacheVersion:
    Type: String
    Description: Redis cache version
    Default: &quot;3.2.4&quot;
  ApplicationApiUrl:
    Type: String
    Description: Intake API URL Endpoint
  ApplicationAuthentication:
    Type: String
    Description: Enables or disables authentication
    Default: &quot;true&quot;
    AllowedValues:
      - &quot;true&quot;
      - &quot;false&quot;
  ApplicationAuthenticationUrl:
    Type: String
    Description: Authentication URL for the Intake Accelerator application
  Environment:
    Type: String
    Description: Stack Environment
  LogRetention:
    Type: Number
    Description: Log retention in days
  NginxDockerImage:
    Type: String
    Description: Docker Image for Nginx
  NginxDockerImageTag:
    Type: String
    Description: Docker Image Tag for Nginx
    Default: latest
  SecretKeyBaseCipher:
    Type: String
    Description: KMS Encrypted Secret Key Base

Conditions:
  ApplicationCacheFailoverEnabled:
    Fn::Equals: 
      - { &quot;Ref&quot; : &quot;ApplicationCacheFailover&quot; }
      - &quot;true&quot;

Resources:
  ApplicationDnsRecord:
    Type: &quot;AWS::Route53::RecordSet&quot;
    Properties:
      Name: 
        Fn::Sub: &quot;${Environment}-intake.${ApplicationDomain}&quot;
      TTL: &quot;300&quot;
      HostedZoneName: &quot;${ApplicationDomain}.&quot;
      Type: &quot;CNAME&quot;
      Comment: 
        Fn::Sub: &quot;Intake Accelerator Application - ${Environment}&quot;
      ResourceRecords: 
        - Fn::Sub: &quot;${ApplicationLoadBalancer.DNSName}&quot;
  ApplicationLoadBalancer:
    Type: &quot;AWS::ElasticLoadBalancingV2::LoadBalancer&quot;
    Properties:
      Scheme: &quot;internet-facing&quot;
      SecurityGroups:
       - Ref: &quot;ApplicationLoadBalancerSecurityGroup&quot;
      Subnets:
        - Fn::ImportValue: DefaultPublicSubnetA
        - Fn::ImportValue: DefaultPublicSubnetB
      LoadBalancerAttributes: 
        - Key: &quot;deletion_protection.enabled&quot;
          Value: false
        - Key: &quot;idle_timeout.timeout_seconds&quot;
          Value: 30
      Tags:
        - Key: &quot;Name&quot;
          Value:
            Fn::Sub: ${AWS::StackName}-${Environment}-lb
  ApplicationLoadBalancerApplicationListener:
    Type: &quot;AWS::ElasticLoadBalancingV2::Listener&quot;
    Properties:
      Certificates:
        - CertificateArn: {&quot;Fn::ImportValue&quot;: &quot;DemoCloudhotspotCoCertificateArn&quot;}
      DefaultActions:
        - TargetGroupArn: { &quot;Ref&quot;: &quot;IntakeAcceleratorServiceTargetGroup&quot; }
          Type: forward
      LoadBalancerArn: { &quot;Ref&quot;: &quot;ApplicationLoadBalancer&quot; }
      Port: { &quot;Ref&quot;: &quot;ApplicationLoadBalancerPort&quot; }
      Protocol: &quot;HTTPS&quot;
  IntakeAcceleratorServiceTargetGroup:
    Type: &quot;AWS::ElasticLoadBalancingV2::TargetGroup&quot;
    Properties:
      VpcId:
        Fn::ImportValue: &quot;DefaultVpcId&quot;
      Protocol: &quot;HTTP&quot;
      Port: { &quot;Ref&quot;: &quot;ApplicationPort&quot; }
      TargetGroupAttributes:
        - Key: &quot;deregistration_delay.timeout_seconds&quot;
          Value: 60
  ApplicationLoadBalancerSecurityGroup:
    Type: &quot;AWS::EC2::SecurityGroup&quot;
    Properties:
      VpcId:
        Fn::ImportValue: &quot;DefaultVpcId&quot;
      GroupDescription: &quot;Intake Accelerator Load Balancer Security Group&quot;
      SecurityGroupIngress:
        - IpProtocol: &quot;tcp&quot;
          FromPort: { &quot;Ref&quot;: &quot;ApplicationLoadBalancerPort&quot; }
          ToPort: { &quot;Ref&quot;: &quot;ApplicationLoadBalancerPort&quot; }
          CidrIp: &quot;0.0.0.0/0&quot;
  ApplicationLoadBalancerToApplicationIngress:
    Type: &quot;AWS::EC2::SecurityGroupIngress&quot;
    Properties:
      IpProtocol: &quot;tcp&quot;
      FromPort: { &quot;Ref&quot;: &quot;ApplicationPort&quot; }
      ToPort: { &quot;Ref&quot;: &quot;ApplicationPort&quot; }
      GroupId: { &quot;Ref&quot;: &quot;ApplicationAutoscalingSecurityGroup&quot; }
      SourceSecurityGroupId: { &quot;Ref&quot;: &quot;ApplicationLoadBalancerSecurityGroup&quot; }
  ApplicationLoadBalancerToApplicationEgress:
    Type: &quot;AWS::EC2::SecurityGroupEgress&quot;
    Properties:
      IpProtocol: &quot;tcp&quot;
      FromPort: { &quot;Ref&quot;: &quot;ApplicationPort&quot; }
      ToPort: { &quot;Ref&quot;: &quot;ApplicationPort&quot; }
      GroupId: { &quot;Ref&quot;: &quot;ApplicationLoadBalancerSecurityGroup&quot; }
      DestinationSecurityGroupId: { &quot;Ref&quot;: &quot;ApplicationAutoscalingSecurityGroup&quot; }
  ApplicationAutoscaling:
    Type: &quot;AWS::AutoScaling::AutoScalingGroup&quot;
    DependsOn:
      - DmesgLogGroup
      - DockerLogGroup
      - EcsAgentLogGroup
      - EcsInitLogGroup
      - MessagesLogGroup
    CreationPolicy:
      ResourceSignal:
        Count: { &quot;Ref&quot;: &quot;ApplicationAutoscalingDesiredCount&quot;}
        Timeout: &quot;PT15M&quot;
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: { &quot;Ref&quot;: &quot;ApplicationAutoscalingDesiredCount&quot;}
        MinSuccessfulInstancesPercent: &quot;100&quot;
        WaitOnResourceSignals: &quot;true&quot;
        PauseTime: &quot;PT15M&quot;
    Properties:
      VPCZoneIdentifier:
        - Fn::ImportValue: &quot;DefaultMediumSubnetA&quot;
        - Fn::ImportValue: &quot;DefaultMediumSubnetB&quot;
      LaunchConfigurationName: { &quot;Ref&quot; : &quot;ApplicationAutoscalingLaunchConfiguration&quot; }
      MinSize: &quot;0&quot;
      MaxSize: &quot;4&quot;
      DesiredCapacity: { &quot;Ref&quot;: &quot;ApplicationAutoscalingDesiredCount&quot;}
      Tags:
        - Key: Name
          Value:
            Fn::Sub: ${AWS::StackName}-instance
          PropagateAtLaunch: &quot;true&quot;
  ApplicationAutoscalingLaunchConfiguration:
    Type: &quot;AWS::AutoScaling::LaunchConfiguration&quot;
    Metadata:
      AWS::CloudFormation::Init:
        config:
          commands:
            10_first_run:
              command: &quot;sh firstrun.sh&quot;
              env:
                STACK_NAME: { &quot;Ref&quot;: &quot;AWS::StackName&quot; }
                AUTOSCALING_GROUP: &quot;ApplicationAutoscaling&quot;
                AWS_DEFAULT_REGION: { &quot;Ref&quot;: &quot;AWS::Region&quot; }
                ECS_CLUSTER: { &quot;Ref&quot;: &quot;ApplicationCluster&quot; }
                DOCKER_NETWORK_MODE: host
                PROXY_URL:
                  Fn::ImportValue: DefaultProxyURL
              cwd: &quot;/home/ec2-user/&quot;
          files:
            /etc/ecs/ecs.config:
              content: 
                Fn::Sub: &quot;ECS_CLUSTER=${ApplicationCluster}\n&quot;
    Properties:
      ImageId: { &quot;Ref&quot;: &quot;ApplicationAMI&quot; }
      InstanceType: { &quot;Ref&quot;: &quot;ApplicationInstanceType&quot; }
      IamInstanceProfile: { &quot;Ref&quot;: &quot;ApplicationAutoscalingInstanceProfile&quot; }
      KeyName: { &quot;Ref&quot;: &quot;ApplicationKeyName&quot; }
      SecurityGroups:
        - Ref: &quot;ApplicationAutoscalingSecurityGroup&quot;
      UserData: 
        Fn::Base64:
          Fn::Join: [&quot;\n&quot;, [
            &quot;#!/bin/bash&quot;,
            &quot;set -e&quot;,
            &quot;Fn::Join&quot;: [&quot;&quot;, [
              &quot;Fn::Sub&quot;: &quot;/opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource ApplicationAutoscalingLaunchConfiguration --region ${AWS::Region}&quot;,
              &quot;    --http-proxy &quot;, &quot;Fn::ImportValue&quot;: &quot;DefaultProxyURL&quot;, 
              &quot;    --https-proxy &quot;, &quot;Fn::ImportValue&quot;: &quot;DefaultProxyURL&quot;
            ] ],
            &quot;Fn::Join&quot;: [&quot;&quot;, [
              &quot;Fn::Sub&quot;: &quot;/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource ApplicationAutoscaling --region ${AWS::Region}&quot;,
              &quot;    --http-proxy &quot;, &quot;Fn::ImportValue&quot;: &quot;DefaultProxyURL&quot;, 
              &quot;    --https-proxy &quot;, &quot;Fn::ImportValue&quot;: &quot;DefaultProxyURL&quot;
            ] ]
          ] ]
  ApplicationAutoscalingSecurityGroup:
    Type: &quot;AWS::EC2::SecurityGroup&quot;
    Properties:
      VpcId:
        Fn::ImportValue: &quot;DefaultVpcId&quot;
      GroupDescription: &quot;Intake Accelerator Security Group&quot;
      SecurityGroupIngress:
        - IpProtocol: &quot;tcp&quot;
          FromPort: 22
          ToPort: 22
          CidrIp:
            Fn::ImportValue: &quot;DefaultManagementSubnetACidr&quot;
        - IpProtocol: &quot;tcp&quot;
          FromPort: 22
          ToPort: 22
          CidrIp:
            Fn::ImportValue: &quot;DefaultManagementSubnetBCidr&quot;
      SecurityGroupEgress:
        - IpProtocol: &quot;tcp&quot;
          FromPort: 3128
          ToPort: 3128
          DestinationSecurityGroupId:
            Fn::ImportValue: DefaultProxySecurityGroup
        - IpProtocol: &quot;udp&quot;
          FromPort: 53
          ToPort: 53
          CidrIp:
            Fn::Join: [&quot;&quot;, [
              &quot;Fn::ImportValue&quot;: &quot;DefaultVpcDnsServer&quot;, &quot;/32&quot;
            ] ]
        - IpProtocol: &quot;udp&quot;
          FromPort: 123
          ToPort: 123
          CidrIp: 0.0.0.0/0
  ApplicationAutoscalingRole:
    Type: &quot;AWS::IAM::Role&quot;
    Properties:
      AssumeRolePolicyDocument:
        Version: &quot;2012-10-17&quot;
        Statement:
          - Effect: &quot;Allow&quot;
            Principal:
              Service: [ &quot;ec2.amazonaws.com&quot; ]
            Action: [ &quot;sts:AssumeRole&quot; ]
      Path: &quot;/&quot;
      ManagedPolicyArns: []
      Policies:
        - {&quot;PolicyName&quot;: &quot;CloudWatchLogs&quot;, &quot;PolicyDocument&quot;: {&quot;Version&quot;: &quot;2012-10-17&quot;, &quot;Statement&quot;: [{&quot;Action&quot;: [&quot;logs:CreateLogGroup&quot;, &quot;logs:CreateLogStream&quot;, &quot;logs:PutLogEvents&quot;, &quot;logs:DescribeLogStreams&quot;], &quot;Resource&quot;: {&quot;Fn::Sub&quot;: &quot;arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${AWS::StackName}*&quot;}, &quot;Effect&quot;: &quot;Allow&quot;}]}}
        - PolicyName: &quot;EC2ContainerInstancePolicy&quot;
          PolicyDocument:
            Statement:
              - Effect: &quot;Allow&quot;
                Action:
                  - &quot;ecs:RegisterContainerInstance&quot;
                  - &quot;ecs:DeregisterContainerInstance&quot;
                Resource: 
                  Fn::Sub: &quot;arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:cluster/${ApplicationCluster}&quot;
              - Effect: &quot;Allow&quot;
                Action:
                  - &quot;ecs:DiscoverPollEndpoint&quot;
                  - &quot;ecs:Submit*&quot;
                  - &quot;ecs:Poll&quot;
                  - &quot;ecs:StartTelemetrySession&quot;
                Resource: &quot;*&quot;
              - Effect: &quot;Allow&quot;
                Action: 
                  - &quot;ecr:BatchCheckLayerAvailability&quot;
                  - &quot;ecr:BatchGetImage&quot;
                  - &quot;ecr:GetDownloadUrlForLayer&quot;
                  - &quot;ecr:GetAuthorizationToken&quot;
                Resource: &quot;*&quot;
              - Effect: &quot;Allow&quot;
                Action:
                - &quot;kms:Decrypt&quot;
                - &quot;kms:DescribeKey&quot;
                Resource:
                  Fn::ImportValue: &quot;CfnMasterKeyArn&quot;
  ApplicationAutoscalingInstanceProfile:
    Type: &quot;AWS::IAM::InstanceProfile&quot;
    Properties:
      Path: &quot;/&quot;
      Roles: [ { &quot;Ref&quot;: &quot;ApplicationAutoscalingRole&quot; } ]
  ApplicationCache:
    Type: &quot;AWS::ElastiCache::ReplicationGroup&quot;
    Properties:
      ReplicationGroupDescription: 
        Fn::Sub: ${AWS::StackName}-redis-cache
      AutomaticFailoverEnabled: { &quot;Ref&quot;: &quot;ApplicationCacheFailover&quot; }
      NumCacheClusters: { &quot;Ref&quot;: &quot;ApplicationCacheInstanceCount&quot; }
      CacheNodeType: { &quot;Ref&quot;: &quot;ApplicationCacheInstanceType&quot; }
      Port: &quot;6379&quot;
      Engine: &quot;redis&quot;
      EngineVersion: { &quot;Ref&quot;: &quot;ApplicationCacheVersion&quot; }
      CacheSubnetGroupName: { &quot;Ref&quot;: &quot;ApplicationCacheSubnetGroup&quot; }
      PreferredMaintenanceWindow: &quot;sun:10:30-sun:12:00&quot;
      SnapshotWindow: 
        Fn::If:
          - &quot;ApplicationCacheFailoverEnabled&quot;
          - &quot;08:00-10:00&quot;
          - { &quot;Ref&quot;: &quot;AWS::NoValue&quot; }
      SecurityGroupIds:
        - { &quot;Ref&quot; : &quot;ApplicationCacheSecurityGroup&quot; }
  ApplicationCacheSubnetGroup:
    Type: &quot;AWS::ElastiCache::SubnetGroup&quot;
    Properties:
      Description:
        Fn::Sub: ${AWS::StackName}-redis-cache-subnet-group
      SubnetIds:
        - Fn::ImportValue: DefaultHighSubnetA
        - Fn::ImportValue: DefaultHighSubnetB
  ApplicationCacheSecurityGroup:
    Type: &quot;AWS::EC2::SecurityGroup&quot;
    Properties:
      GroupDescription:
        Fn::Sub: ${AWS::StackName}-redis-cache-sg
      VpcId:
        Fn::ImportValue: DefaultVpcId
      SecurityGroupEgress:
        - IpProtocol: &quot;icmp&quot;
          FromPort : -1
          ToPort : -1
          CidrIp: &quot;192.0.2.0/24&quot;
  ApplicationToApplicationCacheEgress:
    Type: &quot;AWS::EC2::SecurityGroupEgress&quot;
    Properties:
      IpProtocol: &quot;tcp&quot;
      FromPort: &quot;6379&quot;
      ToPort: &quot;6379&quot;
      GroupId: { &quot;Ref&quot;: &quot;ApplicationAutoscalingSecurityGroup&quot; }
      DestinationSecurityGroupId: { &quot;Ref&quot;: &quot;ApplicationCacheSecurityGroup&quot; }
  ApplicationToApplicationCacheIngress:
    Type: &quot;AWS::EC2::SecurityGroupIngress&quot;
    Properties:
      IpProtocol: &quot;tcp&quot;
      FromPort: &quot;6379&quot;
      ToPort: &quot;6379&quot;
      GroupId: { &quot;Ref&quot;: &quot;ApplicationCacheSecurityGroup&quot; }
      SourceSecurityGroupId: { &quot;Ref&quot;: &quot;ApplicationAutoscalingSecurityGroup&quot; }
  ApplicationCluster:
    Type: &quot;AWS::ECS::Cluster&quot;
  ApplicationTaskDefinition:
    Type: &quot;AWS::ECS::TaskDefinition&quot;
    Properties:
      NetworkMode: host
      Volumes:
        - Name: webroot
          Host: {}
      ContainerDefinitions:
      - Name: intake
        Image:
          Fn::Sub: ${ApplicationDockerImage}:${ApplicationDockerImageTag}
        MemoryReservation: 500
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: 
              Fn::Sub: ${AWS::StackName}/ecs/IntakeAcceleratorService/intake
            awslogs-region: { &quot;Ref&quot;: &quot;AWS::Region&quot; }
            awslogs-stream-prefix: docker
        Environment:
          - Name: KMS_SECRET_KEY_BASE
            Value: { &quot;Ref&quot;: &quot;SecretKeyBaseCipher&quot; }
          - Name: RAILS_ENV
            Value: production
          - Name: NODE_ENV
            Value: production
          - Name: API_URL
            Value: { &quot;Ref&quot;: &quot;ApplicationApiUrl&quot; }
          - Name: REDIS_HOST
            Value:
              Fn::Sub: ${ApplicationCache.PrimaryEndPoint.Address}
          - Name: REDIS_PORT
            Value: &quot;6379&quot;
          - Name: AUTHENTICATION
            Value: { &quot;Ref&quot;: &quot;ApplicationAuthentication&quot; }
          - Name: AUTHENTICATION_URL
            Value: { &quot;Ref&quot;: &quot;ApplicationAuthenticationUrl&quot; }
          - Name: http_proxy
            Value:
              Fn::ImportValue: DefaultProxyURL
          - Name: https_proxy
            Value:
              Fn::ImportValue: DefaultProxyURL
          - Name: no_proxy
            Value: &quot;169.254.169.254,localhost&quot;
        MountPoints:
          - SourceVolume: webroot
            ContainerPath: /tmp
        Command:
          - bundle
          - exec
          - puma
          - -e
          - production
          - -b
          - unix:///tmp/app.sock
          - -C
          - config/puma.rb
      - Name: nginx
        Image:
          Fn::Sub: ${NginxDockerImage}:${NginxDockerImageTag}
        MemoryReservation: 200
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: 
              Fn::Sub: ${AWS::StackName}/ecs/IntakeAcceleratorService/nginx
            awslogs-region: { &quot;Ref&quot;: &quot;AWS::Region&quot; }
            awslogs-stream-prefix: docker
        PortMappings:
        - ContainerPort: { &quot;Ref&quot;: &quot;ApplicationPort&quot; }
          Protocol: tcp
        Environment:
          - Name: HTTP_PORT 
            Value: { &quot;Ref&quot;: &quot;ApplicationPort&quot; }
          - Name: WEB_ROOT
            Value: /ca_intake/public
          - Name: UPSTREAM_URL
            Value: unix:///tmp/app.sock
        MountPoints:
          - SourceVolume: webroot
            ContainerPath: /tmp
        VolumesFrom:
          - SourceContainer: intake
            ReadOnly: &quot;true&quot;
  IntakeAcceleratorService:
    Type: &quot;AWS::ECS::Service&quot;
    DependsOn:
      - ApplicationLoadBalancer
      - ApplicationAutoscaling
      - IntakeAcceleratorServiceLogGroup
      - IntakeAcceleratorNginxLogGroup
    Properties:
      Cluster: { &quot;Ref&quot;: &quot;ApplicationCluster&quot; }
      TaskDefinition: { &quot;Ref&quot;: &quot;ApplicationTaskDefinition&quot; }
      DesiredCount: { &quot;Ref&quot;: &quot;ApplicationAutoscalingDesiredCount&quot;}
      DeploymentConfiguration:
          MinimumHealthyPercent: 50
          MaximumPercent: 200
      LoadBalancers:
        - ContainerName: nginx
          ContainerPort: { &quot;Ref&quot;: &quot;ApplicationPort&quot; }
          TargetGroupArn: { &quot;Ref&quot;: &quot;IntakeAcceleratorServiceTargetGroup&quot; }
      Role: { &quot;Ref&quot;: &quot;EcsServiceRole&quot; }
  EcsServiceRole:
    Type: &quot;AWS::IAM::Role&quot;
    Properties:
      AssumeRolePolicyDocument:
        Version: &quot;2012-10-17&quot;
        Statement:
          - Effect: &quot;Allow&quot;
            Principal: 
              Service: [ &quot;ecs.amazonaws.com&quot; ]
            Action: [ &quot;sts:AssumeRole&quot; ]
      Path: &quot;/&quot;
      ManagedPolicyArns:
        - &quot;arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceRole&quot;
  DmesgLogGroup:
    Type: &quot;AWS::Logs::LogGroup&quot;
    DeletionPolicy: &quot;Delete&quot;
    Properties:
      LogGroupName: 
        Fn::Sub: ${AWS::StackName}/ec2/ApplicationAutoscaling/var/log/dmesg
      RetentionInDays: { &quot;Ref&quot;: &quot;LogRetention&quot; }
  DockerLogGroup:
    Type: &quot;AWS::Logs::LogGroup&quot;
    DeletionPolicy: &quot;Delete&quot;
    Properties:
      LogGroupName:
        Fn::Sub: ${AWS::StackName}/ec2/ApplicationAutoscaling/var/log/docker
      RetentionInDays: { &quot;Ref&quot;: &quot;LogRetention&quot; }
  EcsAgentLogGroup:
    Type: &quot;AWS::Logs::LogGroup&quot;
    DeletionPolicy: &quot;Delete&quot;
    Properties:
      LogGroupName: 
        Fn::Sub: ${AWS::StackName}/ec2/ApplicationAutoscaling/var/log/ecs/ecs-agent
      RetentionInDays: { &quot;Ref&quot;: &quot;LogRetention&quot; }
  EcsInitLogGroup:
    Type: &quot;AWS::Logs::LogGroup&quot;
    DeletionPolicy: &quot;Delete&quot;
    Properties:
      LogGroupName:
        Fn::Sub: ${AWS::StackName}/ec2/ApplicationAutoscaling/var/log/ecs/ecs-init
      RetentionInDays: { &quot;Ref&quot;: &quot;LogRetention&quot; }
  MessagesLogGroup:
    Type: &quot;AWS::Logs::LogGroup&quot;
    DeletionPolicy: &quot;Delete&quot;
    Properties:
      LogGroupName:
        Fn::Sub: ${AWS::StackName}/ec2/ApplicationAutoscaling/var/log/messages
      RetentionInDays: { &quot;Ref&quot;: &quot;LogRetention&quot; }
  IntakeAcceleratorServiceLogGroup:
    Type: &quot;AWS::Logs::LogGroup&quot;
    DeletionPolicy: &quot;Delete&quot;
    Properties:
      LogGroupName:
        Fn::Sub: ${AWS::StackName}/ecs/IntakeAcceleratorService/intake
      RetentionInDays: { &quot;Ref&quot;: &quot;LogRetention&quot; }
  IntakeAcceleratorNginxLogGroup:
    Type: &quot;AWS::Logs::LogGroup&quot;
    DeletionPolicy: &quot;Delete&quot;
    Properties:
      LogGroupName:
        Fn::Sub: ${AWS::StackName}/ecs/IntakeAcceleratorService/nginx
      RetentionInDays: { &quot;Ref&quot;: &quot;LogRetention&quot; }
</code></pre>

<p>4. Once the playbook execution completes successfully, login to the <strong>demo-resources</strong> account in the AWS console.  You should see a new CloudFormation stack called <strong>intake-accelerator-demo</strong> in the <strong>CloudFormation</strong> dashboard:</p>

<p><img src="https://casecommons.github.io/aws-docs/images/intake-accelerator-demo-stack.png" alt="Intake Accelerator Demo Stack" /></p>

<p>5. If you navigate to <strong>ECS &gt; Clusters</strong> you should be able to see the ECS cluster for the Intake Accelerator application.</p>

<p><img src="https://casecommons.github.io/aws-docs/images/intake-accelerator-ecs-cluster.png" alt="Intake Accelerator ECS Cluster" /></p>

<p>6. You can verify the Intake Accelerator is functional by browsing to <code>https://demo-intake.demo.cloudhotspot.co/</code>:</p>

<p><img src="https://casecommons.github.io/aws-docs/images/intake-accelerator.png" alt="Browsing to Intake Accelerator" /></p>

<h2 id="wrap-up">Wrap Up</h2>

<p>We first published a Docker image required for the Intake Accelerator stack to the ECR repository created earlier in this tutotial. We then created a new environment in the Intake Accelerator playbook, learned how to encrypt secrets using the AWS KMS key created earlier in the CloudFormation resources stack, and finally successully deployed the Intake Accelerator stack.</p>


			<aside class="copyright" role="note">
				
				&copy; 2017 Released under the MIT license &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="https://casecommons.github.io/aws-docs/intake-api/" title="Intake API Stack">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Intake API Stack
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="https://casecommons.github.io/aws-docs/" title="AWS CloudFormation Tutorial">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              AWS CloudFormation Tutorial
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = '';
      var repo_id  = '';
    
    </script>

    <script src="https://casecommons.github.io/aws-docs/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

